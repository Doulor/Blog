---
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

const title = i18n(I18nKey.guestbook);
const description = i18n(I18nKey.guestbookSubtitle);
---

<MainGridLayout title={title} description={description}>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-9 py-6 relative w-full">
      <!-- ç•™è¨€æ¿æ ‡é¢˜ -->
      <div class="flex flex-col items-start justify-center mb-8">
        <h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2">
          {i18n(I18nKey.guestbook)}
        </h1>
        <p class="text-lg text-black/60 dark:text-white/60">
          {i18n(I18nKey.guestbookSubtitle)}
        </p>
      </div>

      <!-- æ—¶å…‰èƒ¶å›Šç•™è¨€æ¿åŠŸèƒ½ -->
      <div class="space-y-8">
        <!-- ç•™è¨€è¾“å…¥è§¦å‘æŒ‰é’® -->
        <div class="input-trigger text-center">
          <button
            id="trigger-btn"
            class="trigger-btn bg-gradient-to-r from-purple-500 to-pink-500 text-white border-none rounded-full px-8 py-4 font-medium cursor-pointer transition-all hover:opacity-90 shadow-lg"
          >
            âœï¸ ç•™ä¸‹ä½ çš„å°è®°
          </button>
        </div>

        <!-- å¤šæ¡ç•™è¨€å±•ç¤º -->
        <div>
          <div class="bg-white dark:bg-gray-800 rounded-lg border border-black/10 dark:border-white/10 p-6">
            <div class="flex items-center justify-between mb-4 gap-3 flex-wrap">
              <h2 class="text-2xl font-semibold text-black/90 dark:text-white/90">
                æ—¶å…‰èƒ¶å›Šç•™è¨€æ¿
              </h2>
              <button
                id="refresh-btn"
                type="button"
                onclick="location.reload();"
                class="refresh-btn inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium border border-purple-200/80 dark:border-purple-500/50 bg-purple-50 dark:bg-purple-900/30 text-purple-700 dark:text-purple-200 hover:bg-purple-100 dark:hover:bg-purple-800/50 transition-colors shadow-sm"
              >
                <span class="text-base">ğŸ”„</span>
                <span>åˆ·æ–°ç•™è¨€</span>
              </button>
            </div>
            <div id="messages-container" class="space-y-4">
              <div class="text-center py-8 text-black/60 dark:text-white/60">
                ç‚¹å‡»"åˆ·æ–°ç•™è¨€"æŒ‰é’®å¼€å§‹åŠ è½½ç•™è¨€...
              </div>
            </div>

            <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
             <div id="load-more-btn-container" class="text-center mt-8 hidden">
              <button
                id="load-more-btn"
                class="px-6 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full text-gray-600 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 hover:border-purple-300 dark:hover:border-purple-500 transition-all shadow-sm hover:shadow active:scale-95 text-sm font-medium"
              >
                æŸ¥çœ‹æ›´å¤šç•™è¨€
              </button>
            </div>
          </div>
        </div>

        <!-- è¦†ç›–å¼è¾“å…¥æ¡† -->
        <div id="overlay-input" class="overlay-input fixed inset-0 z-50 hidden">
          <div class="overlay-backdrop absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
          <div class="overlay-content relative bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md mx-4 max-h-[80vh] shadow-2xl border border-gray-200 dark:border-gray-700 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900">
            <div class="overlay-header flex justify-between items-center pb-4 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-lg font-semibold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">ç•™ä¸‹æ—¶å…‰å°è®°</h3>
              <button id="close-btn" class="close-btn text-2xl w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">Ã—</button>
            </div>
            <textarea
              id="message-textarea"
              placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ æƒ³è¯´çš„è¯...å®ƒå°†è¢«æ°¸ä¹…ä¿å­˜åœ¨è¿™ä¸ªæ—¶å…‰èƒ¶å›Šä¸­"
              maxlength="200"
              rows="6"
              class="overlay-textarea w-full border border-gray-300 dark:border-gray-600 rounded-xl p-4 bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 font-medium resize-y min-h-[150px] focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all"
            ></textarea>
            <div class="overlay-actions flex justify-between items-center mt-4">
              <span id="char-count" class="char-count text-sm text-gray-500 dark:text-gray-400">0/200</span>
              <div class="action-buttons flex gap-3">
                <button
                  id="cancel-btn"
                  class="cancel-btn border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg px-4 py-2 font-medium hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                >
                  å–æ¶ˆ
                </button>
                <button
                  id="submit-btn"
                  class="submit-btn-overlay bg-gradient-to-r from-purple-600 to-pink-600 text-white border-none rounded-lg px-5 py-2 font-medium cursor-pointer hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed shadow-md"
                >
                  ğŸ’¾ æ°¸ä¹…ä¿å­˜
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</MainGridLayout>

<style>
  .overlay-input.hidden {
    display: none;
  }

  .overlay-input:not(.hidden) {
    display: flex !important;
    align-items: start !important;
    justify-content: center !important;
    padding-top: 10vh !important;
  }

  /* æ—¶å…‰èƒ¶å›Šç•™è¨€æ¿å¡ç‰‡çš„é¢å¤–æ ·å¼ */
  .message-card {
    transition: all 0.3s ease;
  }

  .message-card {
    position: relative;
    overflow: hidden;
  }

  .message-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, #a855f7, #ec4899, #a855f7);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .message-card:hover::before {
    opacity: 1;
  }

  .message-content {
    position: relative;
    z-index: 1;
  }

  .message-time-absolute {
    margin-top: 1px;
  }

  .refresh-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .refresh-btn:focus-visible {
    outline: 2px solid rgba(168, 85, 247, 0.5);
    outline-offset: 2px;
  }

  /* éª¨æ¶å±åŠ¨ç”» */
  .animate-pulse {
    animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .4; }
  }
</style>

<script>
  // å…¨å±€åˆ·æ–°æŒ‰é’®å…œåº•é€»è¾‘
  document.addEventListener('DOMContentLoaded', () => {
    const refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        refreshBtn.disabled = true;
        refreshBtn.querySelector('span:last-child').textContent = 'åˆ·æ–°ä¸­...';
        window.location.reload();
      });
    }
  });

  // å®¢æˆ·ç«¯è„šæœ¬ç”¨äºå¤„ç†æ—¶å…‰èƒ¶å›Šç•™è¨€æ¿åŠŸèƒ½
  let guestbookInitContainer = null;
  let guestbookForceReinit = false;

  async function initializeGuestbook() {
    // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦ä¸ºç•™è¨€é¡µé¢
    if (!window.location.pathname.includes('/guestbook')) {
      return;
    }

    // è·å–åŸºç¡€ DOM
    const messagesContainer = document.getElementById('messages-container');
    if (!messagesContainer) {
      console.error('æ¶ˆæ¯å®¹å™¨ä¸å­˜åœ¨');
      guestbookForceReinit = true;
      guestbookInitContainer = null;
      return;
    }

    const needFullInit = guestbookForceReinit || messagesContainer !== guestbookInitContainer;
    if (!needFullInit) {
      if (typeof window.loadMessagesFunc === 'function') {
        await window.loadMessagesFunc();
      }
      return;
    }

    guestbookForceReinit = false;
    guestbookInitContainer = messagesContainer;

    // æ£€æŸ¥Supabaseé…ç½®
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

    if (!supabaseUrl || !supabaseAnonKey) {
      console.error('ç¼ºå°‘Supabaseç¯å¢ƒå˜é‡');
      const messagesContainer = document.getElementById('messages-container');
      if (messagesContainer) {
        messagesContainer.innerHTML = '<div class="text-center py-8 text-black/60 dark:text-white/60">è¯„è®ºåŠŸèƒ½æœªé…ç½®</div>';
      }
      return;
    }

    // åŠ¨æ€åŠ è½½Supabaseå®¢æˆ·ç«¯
    const { createClient } = await import('@supabase/supabase-js');
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

  // è·å–DOMå…ƒç´ 
    const triggerBtn = document.getElementById('trigger-btn');
    const overlayInput = document.getElementById('overlay-input');
    const closeBtn = document.getElementById('close-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const refreshBtn = document.getElementById('refresh-btn');
  const submitBtn = document.getElementById('submit-btn');
  const messageTextarea = document.getElementById('message-textarea');
  const charCount = document.getElementById('char-count');

    // å­—ç¬¦è®¡æ•°åŠŸèƒ½
    messageTextarea.addEventListener('input', () => {
      const length = messageTextarea.value.length;
      charCount.textContent = `${length}/200`;
    });

    // æ˜¾ç¤ºè¾“å…¥æ¡†
    function showInput() {
      overlayInput.classList.remove('hidden');
      messageTextarea.focus();
    }

    // éšè—è¾“å…¥æ¡†
    function hideInput() {
      overlayInput.classList.add('hidden');
      messageTextarea.value = '';
      charCount.textContent = '0/200';
    }

    // ç”ŸæˆIPå“ˆå¸Œçš„å‡½æ•°
    async function generateIpHash() {
      try {
        // ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡è·å– IPï¼ˆå¯é€‰ï¼‰
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        const ip = data.ip;

        // å“ˆå¸Œå¤„ç†ï¼ˆä¸å­˜å‚¨çœŸå® IPï¼‰
        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(ip);
        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 16);
      } catch {
        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç”¨æˆ·ä»£ç†å’Œæ—¶é—´çš„ç»„åˆ
        return btoa(navigator.userAgent + Date.now()).substring(0, 16);
      }
    }

    // ========== é˜²åˆ·æœºåˆ¶ç›¸å…³ ==========
    // æœ¬åœ°å­˜å‚¨ä¸Šæ¬¡ç•™è¨€æ—¶é—´çš„key
    const LAST_POST_KEY = 'guestbook_last_post_time';

    // æ£€æŸ¥æ˜¯å¦å…è®¸ç•™è¨€ï¼ˆæ¯5åˆ†é’Ÿåªèƒ½å‘ä¸€æ¬¡ï¼‰
    function canPostMessage() {
      const lastPost = localStorage.getItem(LAST_POST_KEY);
      if (!lastPost) return true;
      const now = Date.now();
      return now - Number(lastPost) >= 5 * 60 * 1000; // 5åˆ†é’Ÿ
    }

    // è®¾ç½®æœ¬åœ°ç•™è¨€æ—¶é—´
    function setLastPostTime() {
      localStorage.setItem(LAST_POST_KEY, Date.now().toString());
    }

    // æäº¤ç•™è¨€
    async function submitMessage() {
      const content = messageTextarea.value.trim();
      if (!content) return;

      // é˜²åˆ·æ ¡éªŒ
      if (!canPostMessage()) {
        alert('æ¯5åˆ†é’Ÿåªèƒ½å‘å¸ƒä¸€æ¡ç•™è¨€ï¼Œè¯·ç¨åå†è¯•ã€‚');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'æŠ•é€’ä¸­...';

      try {
        const ipHash = await generateIpHash();
        const messageData = {
          content: content,
          ip_hash: ipHash,
          user_agent: navigator.userAgent
        };

        const { data, error } = await supabase
          .from('messages')
          .insert([messageData])
          .select()
          .single();

        if (error) throw error;

        setLastPostTime(); // è®°å½•æœ¬æ¬¡ç•™è¨€æ—¶é—´

        hideInput();
        // é‡æ–°åŠ è½½ç•™è¨€åˆ—è¡¨
        await loadMessages();
        alert('ä½ çš„å°è®°å·²æ°¸ä¹…ä¿å­˜ï¼');
      } catch (error) {
        console.error('æäº¤ç•™è¨€å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ æ°¸ä¹…ä¿å­˜';
      }
    }

    // ========== éª¨æ¶å±ç›¸å…³ ==========
    // éª¨æ¶å±HTML
    const skeletonHtml = Array(3).fill(`
      <div class="message-card bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm animate-pulse">
        <div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-4"></div>
        <div class="h-4 bg-gray-100 dark:bg-gray-800 rounded w-1/2 mb-2"></div>
        <div class="h-3 bg-gray-100 dark:bg-gray-800 rounded w-1/3"></div>
      </div>
    `).join('');
    
    // åˆ†é¡µçŠ¶æ€
    let currentOffset = 0;
    const PAGE_SIZE = 20; // æ¢å¤é»˜è®¤æ˜¾ç¤ºæ•°é‡20
    const loadMoreContainer = document.getElementById('load-more-btn-container');
    const loadMoreBtn = document.getElementById('load-more-btn');

    // åŠ è½½æ›´å¤šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    if (loadMoreBtn) {
       loadMoreBtn.onclick = () => loadMessages(true);
    }

    // é‡ç½®åˆ†é¡µçŠ¶æ€ï¼ˆç”¨äºå®Œå…¨åˆ·æ–°æˆ–é‡æ–°æäº¤ç•™è¨€åçš„é‡ç½®ï¼‰
    function resetPagination() {
        currentOffset = 0;
        if (loadMoreContainer) loadMoreContainer.classList.add('hidden');
    }

    // åŠ è½½ç•™è¨€æ—¶æ˜¾ç¤ºéª¨æ¶å±
    async function loadMessages(isLoadMore = false) {
      const messagesContainer = document.getElementById('messages-container');
      
      if (!isLoadMore) {
         resetPagination();
         if (messagesContainer) {
            messagesContainer.innerHTML = skeletonHtml;
         }
      } else {
         if (loadMoreBtn) {
             loadMoreBtn.disabled = true;
             loadMoreBtn.textContent = 'åŠ è½½ä¸­...';
         }
      }

      try {
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .order('created_at', { ascending: false })
          .range(currentOffset, currentOffset + PAGE_SIZE - 1); // ä½¿ç”¨rangeåˆ†é¡µ

        if (error) throw error;
        
        // å¦‚æœæ˜¯é¦–æ¬¡åŠ è½½ä¸”æ— æ•°æ®
        if (!isLoadMore && (!data || data.length === 0)) {
           renderEmptyMessage();
           return;
        }

        if (data && data.length > 0) {
          renderMessages(data, isLoadMore);
          currentOffset += data.length;
          
          // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
          if (data.length < PAGE_SIZE) {
             if (loadMoreContainer) loadMoreContainer.classList.add('hidden');
          } else {
             if (loadMoreContainer) loadMoreContainer.classList.remove('hidden');
          }

        } else if (isLoadMore) {
           // åŠ è½½æ›´å¤šæ—¶å‘ç°æ²¡æœ‰æ›´å¤šæ•°æ®äº†
           if (loadMoreContainer) loadMoreContainer.classList.add('hidden');
        }

      } catch (error) {
        console.error('è·å–ç•™è¨€å¤±è´¥:', error);
        
        if (!isLoadMore) {
            guestbookForceReinit = true;
            guestbookInitContainer = null;
            if (messagesContainer) {
              messagesContainer.innerHTML = '<div class="text-center py-8 text-black/60 dark:text-white/60">åŠ è½½ç•™è¨€å¤±è´¥</div>';
            }
        } else {
            alert('åŠ è½½æ›´å¤šå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } finally {
         if (isLoadMore && loadMoreBtn) {
             loadMoreBtn.disabled = false;
             loadMoreBtn.textContent = 'æŸ¥çœ‹æ›´å¤šç•™è¨€';
         }
      }
    }

    // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
    function renderMessages(messages, isAppend = false) {
      if (!messages || messages.length === 0) {
        if (!isAppend) renderEmptyMessage();
        return;
      }

      const messagesHtml = messages.map(message => `
        <div class="message-card bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition-shadow duration-300">
          <div class="message-content text-gray-700 dark:text-gray-300 mb-3">
            ${message.content}
          </div>
          <div class="message-footer flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
            <div class="message-time-relative">${formatTime(message.created_at)}</div>
            <div class="text-right">
              <div class="message-id inline-block bg-gray-100 dark:bg-gray-600 px-2 py-1 rounded text-xs mb-1">#${message.id.substring(0, 6)}</div>
              <div class="message-time-absolute text-xs opacity-70">${formatAbsoluteTime(message.created_at)}</div>
            </div>
          </div>
        </div>
      `).join('');

      const messagesContainer = document.getElementById('messages-container');
      if (messagesContainer) {
        if (isAppend) {
            messagesContainer.insertAdjacentHTML('beforeend', messagesHtml);
        } else {
            messagesContainer.innerHTML = messagesHtml;
        }
      }
    }

    // æ¸²æŸ“ç©ºçŠ¶æ€
    function renderEmptyMessage() {
      const messagesContainer = document.getElementById('messages-container');
      if (messagesContainer) {
        messagesContainer.innerHTML = `
          <div class="empty-state text-center py-12 text-gray-500 dark:text-gray-400">
            <div class="empty-icon text-5xl mb-4">ğŸ”®</div>
            <p class="text-xl font-medium mb-2">æ—¶å…‰èƒ¶å›Šä¸­è¿˜æ²¡æœ‰ç•™è¨€</p>
            <p class="mb-4">æˆä¸ºç¬¬ä¸€ä¸ªç•™ä¸‹å°è®°çš„äººå§</p>
            <div class="inline-block bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 px-6 py-3 rounded-lg">
              <svg class="w-12 h-12 mx-auto text-purple-400 dark:text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
              </svg>
            </div>
          </div>
        `;
      }
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;

      // 1åˆ†é’Ÿå†…ï¼šåˆšåˆš
      if (diff < 60 * 1000) {
        return 'åˆšåˆš';
      }

      // 1å°æ—¶å†…ï¼šæ˜¾ç¤ºåˆ†é’Ÿ
      if (diff < 60 * 60 * 1000) {
        const minutes = Math.floor(diff / (60 * 1000));
        return `${minutes}åˆ†é’Ÿå‰`;
      }

      // 24å°æ—¶å†…ï¼šæ˜¾ç¤ºå°æ—¶
      if (diff < 24 * 60 * 60 * 1000) {
        const hours = Math.floor(diff / (60 * 60 * 1000));
        return `${hours}å°æ—¶å‰`;
      }

      // è¶…è¿‡24å°æ—¶ï¼šæ˜¾ç¤ºå¤©æ•°
      const days = Math.floor(diff / (24 * 60 * 60 * 1000));
      return `${days}å¤©å‰`;
    }

    // æ ¼å¼åŒ–ç»å¯¹æ—¶é—´æ˜¾ç¤º
    function formatAbsoluteTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    // äº‹ä»¶ç›‘å¬å™¨
    if (triggerBtn) triggerBtn.addEventListener('click', showInput);
    if (closeBtn) closeBtn.addEventListener('click', hideInput);
    if (cancelBtn) cancelBtn.addEventListener('click', hideInput);
    if (submitBtn) submitBtn.addEventListener('click', submitMessage);
    if (refreshBtn) refreshBtn.addEventListener('click', () => {
      refreshBtn.disabled = true;
      refreshBtn.querySelector('span:last-child').textContent = 'åˆ·æ–°ä¸­...';
      window.location.reload();
    });

    // ç‚¹å‡»èƒŒæ™¯å…³é—­è¾“å…¥æ¡†
    document.querySelector('.overlay-backdrop')?.addEventListener('click', hideInput);

    // å°†loadMessageså‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿Swupäº‹ä»¶å¯ä»¥è°ƒç”¨
    window.loadMessagesFunc = loadMessages;

    // åˆå§‹åŒ–åŠ è½½ç•™è¨€åˆ—è¡¨
    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨æµè§ˆå™¨é‡ç»˜åæ‰§è¡Œï¼Œ
    // è¿™æ ·å¯ä»¥é¿å…åœ¨ Swup è¿‡æ¸¡æœŸé—´ DOM çŠ¶æ€ä¸æ­£ç¡®å¯¼è‡´çš„é—®é¢˜
    requestAnimationFrame(() => {
        loadMessages();
    });

  }

  // æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å·²åŠ è½½
  // å¢åŠ å¯¹ popstate äº‹ä»¶çš„ç›‘å¬ï¼Œå¤„ç†æµè§ˆå™¨åé€€æŒ‰é’®
  const handleInitialLoad = () => {
     if (window.location.pathname.includes('/guestbook')) {
        setTimeout(initializeGuestbook, 100);
     }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', handleInitialLoad);
  } else {
    handleInitialLoad();
  }
  
  window.addEventListener('popstate', handleInitialLoad);

  function scheduleGuestbookInit(attempt = 0) {
    if (!window.location.pathname.includes('/guestbook')) return;
    
    // å¼ºåˆ¶é‡ç½®åˆå§‹åŒ–çŠ¶æ€ï¼Œç¡®ä¿Swupåˆ‡æ¢å›æ¥æ—¶èƒ½é‡æ–°ç»‘å®š
    console.log(`Trying to init guestbook attempt: ${attempt}`);
    guestbookForceReinit = true;
    guestbookInitContainer = null;

    const messagesContainer = document.getElementById('messages-container');
    
    // å¦‚æœæ‰¾åˆ°äº†å®¹å™¨ï¼Œæ‰§è¡Œåˆå§‹åŒ–
    if (messagesContainer) {
      setTimeout(() => {
        initializeGuestbook();
      }, 50);
      return;
    }

    // é‡è¯•æœºåˆ¶
    if (attempt >= 20) { // å¢åŠ é‡è¯•æ¬¡æ•°
      return;
    }

    setTimeout(() => scheduleGuestbookInit(attempt + 1), 100);
  }

  // ç›‘å¬Swupé¡µé¢åˆ‡æ¢äº‹ä»¶
  // ä½¿ç”¨ content:replace å› ä¸ºæ­¤æ—¶æ–°å†…å®¹å·²æ’å…¥ DOMï¼Œä½†å°šæœªæ˜¾ç¤º
  // ä½¿ç”¨ page:view ç¡®ä¿é¡µé¢å·²å®Œå…¨å¯è§
  
  if (window.swup && window.swup.hooks) {
    // ç¡®ä¿åœ¨å†…å®¹æ›¿æ¢åï¼ˆå³è¿›å…¥æ–°é¡µé¢ï¼‰ç«‹å³å¼€å§‹å°è¯•å¯»æ‰¾ DOM
    window.swup.hooks.on('content:replace', () => {
        console.log('Swup content:replace triggered');
        scheduleGuestbookInit();
    });
    // å†æ¬¡ä¿éšœï¼Œåœ¨é¡µé¢è§†å›¾ç¡®è®¤åæ£€æŸ¥
    window.swup.hooks.on('page:view', () => {
        console.log('Swup page:view triggered');
        scheduleGuestbookInit();
    });
  } else {
      // å…¼å®¹é Swup ç¯å¢ƒæˆ–è€… Swup æœªåŠ è½½
      document.addEventListener('swup:content:replace', scheduleGuestbookInit);
      document.addEventListener('swup:page:view', scheduleGuestbookInit);
  }


  // é’ˆå¯¹æœ¬é¡¹ç›®è‡ªå®šä¹‰äº‹ä»¶
  document.addEventListener('mizuki:page:loaded', () => {
     scheduleGuestbookInit();
  });
</script>