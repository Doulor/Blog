---
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import { getCollection } from 'astro:content';
import { siteConfig } from '../config';

// æ£€æµ‹æ˜¯å¦ä¸ºå¤–éƒ¨å›¾ç‰‡é“¾æ¥
function isExternalUrl(url: string): boolean {
  try {
    const parsed = new URL(url);
    return /^https?:$/.test(parsed.protocol);
  } catch {
    return false;
  }
}

// è§„èŒƒåŒ–å›¾ç‰‡å­—æ®µï¼Œå…¼å®¹ "[text](https://...)" å†™æ³•
function normalizeImage(url: string): string {
  const match = url.match(/\((https?:[^)]+)\)/);
  return match ? match[1] : url.trim();
}

function isImageUrl(url: string): boolean {
  return /\.(png|jpe?g|gif|webp|avif|svg|bmp)(\?|#|$)/i.test(url);
}

// è·å–å®é™…æ—¥è®°æ•°æ®å¹¶æŒ‰æ—¥æœŸæ’åº
const diaries = await getCollection('diary')
  .then(items => items.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()));

// é»˜è®¤æ˜¾ç¤ºæ¡æ•°ï¼ˆæŸ¥çœ‹æ›´å¤šæŒ‰é’®é€æ­¥è¿½åŠ ï¼‰
const DIARY_PAGE_SIZE = 20;

// ç›¸å¯¹æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatTime(dateInput: string | Date): string {
  const date = new Date(dateInput);
  const now = new Date();
  const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));

  if (diffInMinutes < 60) return `${diffInMinutes}${i18n(I18nKey.diaryMinutesAgo)}`;
  if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}${i18n(I18nKey.diaryHoursAgo)}`;
  return `${Math.floor(diffInMinutes / 1440)}${i18n(I18nKey.diaryDaysAgo)}`;
}

// ç»å¯¹æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
function formatDate(dateInput: string | Date): string {
  const date = new Date(dateInput);
  const lang = siteConfig.lang || "zh-CN"; // ä½¿ç”¨ç«™ç‚¹é…ç½®çš„è¯­è¨€æˆ–é»˜è®¤ä¸­æ–‡
  // å°†é…ç½®è¯­è¨€æ˜ å°„ä¸ºå¯ç”¨çš„localeæ ‡è¯†ç¬¦
  const localeMap: Record<string, string> = {
    "zh_CN": "zh-CN",
    "zh_TW": "zh-TW",
    "en": "en-US",
    "ja": "ja-JP"
  };
  const locale = localeMap[lang] || lang;

  return date.toLocaleDateString(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'short'
  });
}
---

<MainGridLayout title={i18n(I18nKey.diary)} description="å³åˆ»çŸ­æ–‡">
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
      <div class="relative max-w-4xl">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="moments-header mb-6">
          <div class="header-content">
            <div class="header-info">
              <h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-90 mb-1">{i18n(I18nKey.diary)}</h1>
              <p class="moments-subtitle text-sm md:text-base lg:text-lg text-75">{i18n(I18nKey.diarySubtitle)}</p>
            </div>
            <div class="header-stats">
              <div class="stat-item text-center">
                <span class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-[var(--primary)]">{diaries.length}</span>
                <span class="stat-label text-xs md:text-sm lg:text-base text-75">{i18n(I18nKey.diaryCount)}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- çŸ­æ–‡åˆ—è¡¨ -->
        <div class="moments-timeline">
          <div id="diary-list" class="timeline-list space-y-4">
            {diaries.map((diary, index) => {
              const dateObj = new Date(diary.data.date);
              const dateIso = dateObj.toISOString();
              return (
              <div
                class="moment-item card-base p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all cursor-pointer"
                data-index={index}
                data-href={`/diary/${diary.slug}/`}
                role="link"
                tabindex="0"
                aria-label={`æ‰“å¼€æ—¥è®°ï¼š${diary.data.title || diary.slug}`}
              >
                  <div class="moment-content">
                    {/* æ–°å¢ï¼šæ—¥è®°æ ‡é¢˜ï¼ˆä¿æŒåŸæœ‰è®¾è®¡è¯­è¨€ï¼‰ */}
                    {diary.data.title && (
                      <h3 class="moment-title text-base md:text-lg lg:text-xl font-semibold text-90 mb-2 md:mb-3 leading-tight">
                        {diary.data.title}
                      </h3>
                    )}

                    {/* ä½¿ç”¨excerptæˆ–bodyå†…å®¹ï¼Œå¹¶æ·»åŠ å®‰å…¨æ£€æŸ¥ */}
                    <p class="moment-text text-sm md:text-base lg:text-lg text-90 leading-relaxed mb-3 md:mb-4">
                      {diary.data.excerpt || diary.body?.slice(0, 200) + '...' || ''}
                    </p>

                    {/* å¤„ç†å›¾ç‰‡æ˜¾ç¤º */}
                    {diary.data.images && diary.data.images.length > 0 && (() => {
                      const images = (diary.data.images || []).filter((item) => isImageUrl(normalizeImage(item)));
                      const previewImages = images.slice(0, 3);
                      const remaining = images.length - previewImages.length;
                      return (
                        <div class="moment-images grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-2 md:gap-3 lg:gap-4 mb-3 md:mb-4">
                          {previewImages.map((image, imageIndex) => {
                            const normalized = normalizeImage(image);
                            const external = isExternalUrl(normalized);
                            const displaySrc = external ? normalized : `/images/diary/${normalized}`;
                            const showMore = remaining > 0 && imageIndex === previewImages.length - 1;
                            return (
                              <a
                                href={displaySrc}
                                class="image-item relative rounded-md overflow-hidden aspect-square cursor-pointer hover:scale-105 transition-transform block"
                                data-lightbox-src={displaySrc}
                                aria-label={i18n(I18nKey.diaryImage)}
                              >
                                <img
                                  src={displaySrc}
                                  alt={i18n(I18nKey.diaryImage)}
                                  class="w-full h-full object-cover"
                                  loading="lazy"
                                  decoding="async"
                                />
                                <div class="absolute inset-0 bg-black/20 opacity-0 hover:opacity-100 transition-opacity duration-200 pointer-events-none"></div>
                                {showMore && (
                                  <div class="absolute inset-0 bg-black/45 flex items-center justify-center text-white text-lg font-semibold">
                                    +{remaining}
                                  </div>
                                )}
                              </a>
                            );
                          })}
                        </div>
                      );
                    })()}

                    {/* å·²å®ç°å¡ç‰‡æ•´å—å¯ç‚¹å‡»è·³è½¬ï¼Œä¸å†éœ€è¦å•ç‹¬çš„â€œæ‰“å¼€æ—¥è®°â€æŒ‰é’® */}

                  </div>
                
                <hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4" />
                
                <div class="moment-footer flex justify-between items-center">
                  <div class="moment-time flex items-center gap-2 text-75 text-xs md:text-sm lg:text-base">
                    <i class="time-icon text-xs md:text-sm">ğŸ“…</i>
                    <time datetime={dateIso} class="absolute-date">
                      {formatDate(dateObj)}
                    </time>
                    <span class="relative-date text-xs md:text-sm lg:text-base">| {formatTime(dateObj)}</span>
                  </div>
                </div>
              </div>
              );
            })}
          </div>
        </div>

        <!-- æŸ¥çœ‹æ›´å¤šæ—¥è®°æŒ‰é’® -->
        <div id="diary-load-more-container" class="text-center mt-8">
          <button
            id="diary-load-more"
            type="button"
            class="px-6 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-full text-gray-600 dark:text-gray-300 hover:text-purple-600 dark:hover:text-purple-400 hover:border-purple-300 dark:hover:border-purple-500 transition-all shadow-sm hover:shadow active:scale-95 text-sm font-medium"
          >
            æŸ¥çœ‹æ›´å¤šæ—¥è®°
          </button>
        </div>

        {/* åº•éƒ¨æç¤º */}
        <div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
          {i18n(I18nKey.diaryTips)}
        </div>
      </div>
    </div>
  </div>
</MainGridLayout>

<script is:inline define:vars={{ PAGE_SIZE: DIARY_PAGE_SIZE }}>
  (function () {
    const list = document.getElementById('diary-list');
    const btn = document.getElementById('diary-load-more');
    const container = document.getElementById('diary-load-more-container');
    if (!list || !btn || !container) return;

    const items = Array.from(list.querySelectorAll('.moment-item'));
    let visible = 0;

    function applyVisibility() {
      items.forEach((el, idx) => {
        el.style.display = idx < visible ? '' : 'none';
      });

      if (visible >= items.length) {
        container.style.display = 'none';
      } else {
        container.style.display = '';
      }
    }

    function showMore() {
      visible = Math.min(items.length, visible + PAGE_SIZE);
      applyVisibility();
    }

    // åˆå§‹æ˜¾ç¤º 20 æ¡
    visible = Math.min(items.length, PAGE_SIZE);
    applyVisibility();

    btn.addEventListener('click', showMore);

    // swup åˆ‡æ¢å›æ¥æ—¶å…œåº•é‡ç½®
    document.addEventListener('swup:contentReplaced', () => {
      visible = Math.min(items.length, PAGE_SIZE);
      applyVisibility();
    });
  })();
</script>

<script is:inline>
  (function () {
    // é¿å… Swup å¾€è¿”åé‡å¤ç»‘å®šå¯¼è‡´ç‚¹å‡»é€»è¾‘å¼‚å¸¸
    if (window.__mizukiDiaryCardNavBound__) return;
    window.__mizukiDiaryCardNavBound__ = true;

    function shouldIgnore(e) {
      const t = e.target;
      if (!(t instanceof Element)) return false;
  // ç‚¹å‡»å›¾ç‰‡/ç¯ç®±è§¦å‘å™¨æ—¶ä¸è·³è½¬
  if (t.closest('[data-lightbox-src], .moment-images img')) return true;
      // ç‚¹å‡»ä»»ä½•é“¾æ¥/æŒ‰é’®/è¡¨å•æ§ä»¶æ—¶ä¿ç•™å…¶é»˜è®¤è¡Œä¸º
      if (t.closest('a, button, input, textarea, select, summary')) return true;
      return false;
    }

    function handleCardClick(e) {
      if (shouldIgnore(e)) return;
      const t = e.target;
      if (!(t instanceof Element)) return;
      const card = t.closest('.moment-item[data-href]');
      if (!card) return;
      const href = card.getAttribute('data-href');
      if (!href) return;

      // Swup åœºæ™¯ä¸‹ä¼˜å…ˆç”¨ swup.navigateï¼Œé¿å… history/ç¼“å­˜çŠ¶æ€å¯¼è‡´çš„â€œè¿”å›åæ— æ³•è¿›å…¥â€
      if (window.swup && typeof window.swup.navigate === 'function') {
        window.swup.navigate(href);
      } else {
        window.location.href = href;
      }
    }

    function handleCardKeydown(e) {
      if (!(e.target instanceof Element)) return;
      const card = e.target.closest('.moment-item[data-href]');
      if (!card) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const href = card.getAttribute('data-href');
        if (!href) return;
        if (window.swup && typeof window.swup.navigate === 'function') {
          window.swup.navigate(href);
        } else {
          window.location.href = href;
        }
      }
    }

    document.addEventListener('click', handleCardClick);
    document.addEventListener('keydown', handleCardKeydown);
  })();
</script>

<style>
  /* ä¿ç•™åŸå§‹æ‰€æœ‰æ ·å¼ */
  .card-base {
    background: var(--card-bg);
    border: 1px solid var(--line-divider);
    transition: all 0.3s ease;
  }
  
  .moments-header {
    padding: 1rem;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, var(--primary)) 100%);
    color: white;
    position: relative;
    overflow: hidden;
  }
  
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
  }
  
  .moments-title {
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  
  .moments-subtitle {
    color: rgba(255, 255, 255, 0.9);
  }
  
  .stat-number {
    color: white;
  }
  
  .stat-label {
    color: rgba(255, 255, 255, 0.8);
  }
  
  .image-item img {
    transition: transform 0.3s ease;
  }
  
  .image-item:hover img {
    transform: scale(1.05);
  }
  
  .action-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-muted);
  }
  
  .action-btn:hover {
    color: var(--primary);
  }

  /* æ–°å¢æ ‡é¢˜æ ·å¼ï¼ˆä¸ç°æœ‰é£æ ¼ç»Ÿä¸€ï¼‰ */
  .moment-title {
    color: var(--text-primary);
    font-family: inherit;
    transition: color 0.3s ease;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 640px) {
    .moments-header {
      padding: 0.75rem;
    }
    
    .header-content {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }
    
    .moment-images {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .moment-footer {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .moment-title {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
  }
  
  @media (min-width: 641px) and (max-width: 900px) {
    .moments-header {
      padding: 1.25rem;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .moment-item {
      padding: 1.5rem;
    }
    
    .moment-images {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      max-width: 500px;
    }
    
    .moment-text {
      font-size: 1rem;
      line-height: 1.7;
    }

    .moment-title {
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
    }
    
    .moment-footer {
      margin-top: 1rem;
    }
  }
  
  @media (min-width: 901px) {
    .moments-header {
      padding: 1.5rem;
    }
    
    .moment-item {
      padding: 2rem;
    }
    
    .moment-images {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      max-width: 600px;
      gap: 1rem;
    }
    
    .moment-text {
      font-size: 1.1rem;
      line-height: 1.8;
    }

    .moment-title {
      font-size: 1.25rem;
      margin-bottom: 0.875rem;
    }
  }
  
  @media (max-width: 480px) {
    .card-base {
      margin: 0 -0.5rem;
    }
    
    .moment-item {
      border-radius: 8px;
    }
    
    .moments-header {
      border-radius: 6px;
    }
  }
</style>