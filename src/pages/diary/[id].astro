---
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import Layout from "../../layouts/Layout.astro";
import { getEntry } from 'astro:content';

// 检测外部图片链接的函数
function isExternalUrl(url) {
  try {
    const parsed = new URL(url);
    return /^https?:$/.test(parsed.protocol);
  } catch {
    return false;
  }
}

export async function getStaticPaths() {
  const { getCollection } = await import("astro:content");
  const diaries = await getCollection('diary');
  return diaries.map((diary) => ({
    params: { id: diary.slug },
    props: { diary },
  }));
}

const { diary } = Astro.props;
---

<Layout title={diary.data.title} description={diary.data.description || diary.body?.slice(0, 160)}>
  <div class="flex w-full min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 py-8" style="opacity: 0;" id="main-container">
    <div class="max-w-4xl w-full mx-auto px-4">
      <!-- 主卡片 -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-700">
        <!-- 返回按钮区域 - 使用低调但明显的颜色 -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center">
            <a href="/diary/" class="inline-flex items-center gap-2 text-white bg-gray-600 hover:bg-gray-700 transition-colors text-base font-medium px-4 py-2 rounded-lg shadow">
              <i class="fas fa-arrow-left"></i> 返回日记列表
            </a>
          </div>
        </div>

        <!-- 内容区域 -->
        <article class="p-6 md:p-8">
          <header class="mb-6">
            <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white mb-3">
              {diary.data.title}
            </h1>
            <div class="flex flex-wrap items-center gap-4 text-gray-600 dark:text-gray-400 text-sm md:text-base">
              <time datetime={diary.data.date} class="flex items-center gap-1.5">
                <i class="fas fa-calendar text-gray-500"></i>
                {new Date(diary.data.date).toLocaleDateString('zh-CN', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  weekday: 'long'
                })}
              </time>
            </div>
          </header>

          <div class="prose prose-lg dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-relaxed text-base mb-6 md:mb-8">
            {diary.body}
          </div>

          {/* 在正文和图片之间添加分隔符 */}
          {diary.data.images && diary.data.images.length > 0 && (
            <hr class="border-t border-gray-200 dark:border-gray-700 my-6" />
          )}

          {/* 处理图片显示 - 移到内容下方 */}
          {diary.data.images && diary.data.images.length > 0 && (
            <div class="moment-images grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
              {diary.data.images.map((image, index) => (
                <div class="image-item relative rounded-xl overflow-hidden aspect-square cursor-pointer shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 group" key={index}>
                  <img
                    src={isExternalUrl(image) ? image : `/images/diary/${image}`}
                    alt={`${diary.data.title} - 图片 ${index + 1}`}
                    class="w-full h-full object-cover"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                    <i class="fas fa-search-plus text-white text-2xl"></i>
                  </div>
                </div>
              ))}
            </div>
          )}
        </article>
      </div>
    </div>
  </div>

  <script>
    // 添加页面进入动画
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('main-container');
      setTimeout(() => {
        container.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
      }, 50);
    });

    // 为图片添加点击放大功能，添加动画效果
    document.addEventListener('DOMContentLoaded', () => {
      const imageItems = document.querySelectorAll('.image-item');

      imageItems.forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.tagName === 'IMG' || e.target.closest('.image-item')) {
            // 获取图片元素
            const img = e.target.tagName === 'IMG' ? e.target : e.target.closest('.image-item').querySelector('img');
            const imgSrc = img.src;
            const imgAlt = img.alt;

            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/95 z-[9999] flex items-center justify-center p-4 cursor-zoom-out opacity-0';
            modal.innerHTML = `
              <div class="relative max-w-6xl max-h-[90vh] transform scale-95">
                <img src="${imgSrc}" alt="${imgAlt}" class="max-h-[80vh] max-w-full object-contain block mx-auto rounded-lg" />
                <button class="absolute top-4 right-4 text-white bg-black/50 hover:bg-black/70 rounded-full w-10 h-10 flex items-center justify-center text-2xl transition-colors"
                        style="cursor: pointer;">&times;</button>
              </div>
            `;

            document.body.appendChild(modal);

            // 触发进入动画
            setTimeout(() => {
              modal.style.transition = 'opacity 0.3s ease';
              modal.style.opacity = '1';

              const modalContent = modal.querySelector('div');
              if (modalContent) {
                modalContent.style.transition = 'transform 0.3s ease';
                modalContent.style.transform = 'scale(1)';
              }
            }, 10);

            // 关闭模态框事件
            const closeBtn = modal.querySelector('button');
            closeBtn.addEventListener('click', () => {
              // 触发退出动画
              modal.style.transition = 'opacity 0.3s ease';
              modal.style.opacity = '0';

              const modalContent = modal.querySelector('div');
              if (modalContent) {
                modalContent.style.transition = 'transform 0.3s ease';
                modalContent.style.transform = 'scale(0.95)';
              }

              setTimeout(() => {
                document.body.removeChild(modal);
              }, 300);
            });

            // 点击模态框背景关闭
            modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                // 触发退出动画
                modal.style.transition = 'opacity 0.3s ease';
                modal.style.opacity = '0';

                const modalContent = modal.querySelector('div');
                if (modalContent) {
                  modalContent.style.transition = 'transform 0.3s ease';
                  modalContent.style.transform = 'scale(0.95)';
                }

                setTimeout(() => {
                  document.body.removeChild(modal);
                }, 300);
              }
            });
          }
        });
      });
    });
  </script>
</Layout>