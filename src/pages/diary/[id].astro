---
import { join } from "node:path";
import MainGridLayout from "../../layouts/MainGridLayout.astro";
import Markdown from "../../components/misc/Markdown.astro";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import { siteConfig } from "../../config";
import { getDir } from "../../utils/url-utils";
import ImageWrapper from "../../components/misc/ImageWrapper.astro";

// æ£€æµ‹å¤–éƒ¨å›¾ç‰‡é“¾æ¥çš„å‡½æ•°
function isExternalUrl(url: string): boolean {
	try {
		const parsed = new URL(url);
		return /^https?:$/.test(parsed.protocol);
	} catch {
		return false;
	}
}

// è§„èŒƒåŒ–å›¾ç‰‡å­—æ®µï¼Œå…¼å®¹ç±»ä¼¼ "[xxx](https://...)" çš„å†™æ³•
function normalizeImage(url: string): string {
  const match = url.match(/\((https?:[^)]+)\)/);
  return match ? match[1] : url.trim();
}

// ç»å¯¹æ—¶é—´æ ¼å¼åŒ–ï¼ˆæ²¿ç”¨åˆ—è¡¨é¡µé€»è¾‘ï¼‰
function formatDate(dateInput: string | Date): string {
  const date = new Date(dateInput);
	const lang = siteConfig.lang || "zh-CN";
	const localeMap: Record<string, string> = {
		"zh_CN": "zh-CN",
		"zh_TW": "zh-TW",
		"en": "en-US",
		"ja": "ja-JP",
	};
	const locale = localeMap[lang] || lang;

	return date.toLocaleDateString(locale, {
		year: "numeric",
		month: "long",
		day: "numeric",
		weekday: "short",
	});
}

// ç›¸å¯¹æ—¶é—´æ˜¾ç¤º
function formatTime(dateInput: string | Date): string {
  const now = new Date();
  const date = new Date(dateInput);
	const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));

	if (diffInMinutes < 60) return `${diffInMinutes}${i18n(I18nKey.diaryMinutesAgo)}`;
	if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}${i18n(I18nKey.diaryHoursAgo)}`;
	return `${Math.floor(diffInMinutes / 1440)}${i18n(I18nKey.diaryDaysAgo)}`;
}

export async function getStaticPaths() {
	const { getCollection } = await import("astro:content");
	const diaries = await getCollection("diary");
	return diaries.map((diary) => ({
		params: { id: diary.slug },
		props: { diary },
	}));
}

const { diary } = Astro.props;
const { Content, headings } = await diary.render();
const gallery = diary.data.images || [];
const description =
	diary.data.description ||
	diary.data.excerpt ||
	diary.body?.slice(0, 160) ||
	i18n(I18nKey.diarySubtitle);
const diaryBasePath = join("content/", getDir(diary.id));
const diaryDate = new Date(diary.data.date);
const diaryDateIso = diaryDate.toISOString();
---

<MainGridLayout
  title={diary.data.title}
  description={description}
  lang={diary.data.lang || siteConfig.lang}
  setOGTypeArticle={true}
  headings={headings}
>
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
    <div class="card-base z-10 px-5 md:px-8 lg:px-10 py-6 md:py-8 relative w-full">
      <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
        <a
          href="/diary/"
          class="inline-flex items-center gap-2 px-4 md:px-5 py-2.5 rounded-xl text-sm md:text-base font-semibold text-white bg-[var(--primary)] hover:bg-[color:var(--primary-dark,var(--primary))] shadow-lg hover:shadow-xl transition transform hover:-translate-y-[1px] active:scale-95 focus:outline-none focus:ring-2 focus:ring-[var(--primary)] focus:ring-offset-2 focus:ring-offset-[var(--card-bg)]"
        >
          <span class="text-lg">â†</span>
          <span>{i18n(I18nKey.diary)}</span>
        </a>
        <div class="flex flex-col text-right text-75 text-xs md:text-sm">
          <time datetime={diaryDateIso} class="font-semibold text-90">{formatDate(diaryDate)}</time>
          <span class="mt-0.5">{formatTime(diaryDate)}</span>
        </div>
      </div>

      <header class="mb-4 md:mb-6">
        <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-90 leading-tight mb-2">{diary.data.title}</h1>
        {description && (
          <p class="text-75 text-sm md:text-base leading-relaxed">{description}</p>
        )}
      </header>

      <Markdown class="markdown-content onload-animation mb-8" data-lightbox-base={diaryBasePath}>
        <Content />
      </Markdown>

      {gallery.length > 0 && (
        <section class="space-y-3">
          <div class="flex items-center gap-2 text-75 text-sm font-semibold">
            <span>ğŸ“·</span>
            <span>{i18n(I18nKey.diaryImage) || "Images"}</span>
            <span class="text-xs text-60">({gallery.length})</span>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
            {gallery.map((image: string, index: number) => {
              const normalized = normalizeImage(image);
              const external = isExternalUrl(normalized);
              return (
                <div 
                  class="relative rounded-xl overflow-hidden aspect-square group border border-[var(--line-divider)] bg-[var(--card-bg)] cursor-pointer"
                  data-lightbox-src={external ? normalized : join(diaryBasePath, normalized)}
                  data-lightbox-alt={`${diary.data.title} - ${index + 1}`}
                >
                  {external ? (
                    <img
                      src={normalized}
                      alt={`${diary.data.title} - ${index + 1}`}
                      class="w-full h-full object-cover transition duration-300 group-hover:scale-105"
                      loading="lazy"
                    />
                  ) : (
                    <ImageWrapper
                      src={normalized}
                      alt={`${diary.data.title} - ${index + 1}`}
                      class="w-full h-full"
                      basePath={diaryBasePath}
                    />
                  )}
                  <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                </div>
              );
            })}
          </div>
        </section>
      )}
    </div>
  </div>
</MainGridLayout>

<script is:inline src="/js/lightbox.js"></script>
<script>
  // ä¸º Markdown å†…å®¹ä¸­çš„å›¾ç‰‡åŠ¨æ€æ·»åŠ  data-lightbox-src
  function setupMarkdownLightbox() {
    const markdownContent = document.querySelector('.markdown-content');
    if (!markdownContent) return;

    const images = markdownContent.querySelectorAll('img');
    images.forEach(img => {
      // å¦‚æœçˆ¶å…ƒç´ å·²ç»æ˜¯ç¯ç®±è§¦å‘å™¨ï¼Œåˆ™è·³è¿‡
      if (img.closest('[data-lightbox-src]')) return;

      // ä¸ºå›¾ç‰‡æœ¬èº«æˆ–å…¶æœ€è¿‘çš„çˆ¶é“¾æ¥æ·»åŠ å±æ€§
      const parentLink = img.closest('a');
      const targetEl = parentLink || img;

      if (!targetEl.hasAttribute('data-lightbox-src')) {
        targetEl.setAttribute('data-lightbox-src', img.src);
        targetEl.setAttribute('data-lightbox-alt', img.alt);
      }
    });
  }

  document.addEventListener('astro:page-load', setupMarkdownLightbox);
  document.addEventListener('astro:after-swap', setupMarkdownLightbox);
</script>