---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
---

<MainGridLayout title="å†…å®¹åˆ›å»ºå™¨" description="åˆ›å»ºæ–°çš„åšå®¢æ–‡ç« ã€æ—¥è®°å’Œç›¸å†Œ">
  <div class="card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-3">
        å†…å®¹åˆ›å»ºå™¨
      </h1>
      <p class="text-neutral-600 dark:text-neutral-400">
        å¿«é€Ÿåˆ›å»ºåšå®¢å†…å®¹ï¼Œæ”¯æŒå¸–å­ã€æ—¥è®°å’Œç›¸å†Œ
      </p>
    </header>

    <!-- è®¤è¯çŠ¶æ€ -->
    <div class="mb-8 p-4 rounded-xl bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/30 dark:to-blue-900/30 border border-green-200 dark:border-green-800">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-medium text-lg">GitHubè®¤è¯çŠ¶æ€</h3>
          <p id="create-auth-status" class="text-sm text-gray-600 dark:text-gray-400 flex items-center">
            <span id="create-auth-status-indicator" class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
            <span id="create-auth-status-text">æœªè®¤è¯</span>
          </p>
        </div>
        <div class="flex space-x-2">
          <button type="button" class="btn-card h-12 px-4 rounded-lg" title="åˆ·æ–°è®¤è¯çŠ¶æ€" onclick="location.reload();">
            <i class="fa fa-refresh mr-1" aria-hidden="true"></i>åˆ·æ–°
          </button>
          <button id="create-auth-btn" class="btn-card h-12 px-4 rounded-lg">
            <span id="create-auth-btn-text">ç™»å½•</span>
          </button>
        </div>
      </div>
      
      <!-- æ¶ˆæ¯åŒºåŸŸ -->
      <div id="message-area" class="mt-4 hidden">
        <div id="info-message" class="p-4 rounded-lg bg-blue-50 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200 border border-blue-200 dark:border-blue-800"></div>
        <div id="error-message" class="p-4 rounded-lg bg-red-50 text-red-800 dark:bg-red-900/30 dark:text-red-200 border border-red-200 dark:border-red-800 mt-2 hidden"></div>
      </div>
      
      <!-- GitHub Token è¾“å…¥æ¨¡æ€æ¡† -->
      <div id="create-auth-modal" class="fixed inset-0 bg-black bg-opacity-0 flex items-start justify-center z-50 hidden transition-opacity duration-500">
        <div class="bg-white dark:bg-neutral-800 rounded-xl p-6 w-full max-w-md shadow-2xl mt-16 transform translate-y-0 opacity-0 transition-all duration-500 scale-95">
          <h3 class="text-lg font-semibold mb-4 text-neutral-900 dark:text-neutral-100">GitHub Personal Access Token</h3>
          <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-4">
            è¯·è¾“å…¥æ‚¨çš„GitHub Personal Access Tokenã€‚è¯¥Tokenä»…åœ¨æœ¬åœ°å­˜å‚¨ï¼Œç”¨äºè®¿é—®æ‚¨çš„ä»“åº“ã€‚
          </p>
          <div class="mb-4">
            <input 
              type="password" 
              id="create-token-input" 
              placeholder="è¾“å…¥æ‚¨çš„Personal Access Token" 
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
            >
          </div>
          <div class="flex justify-end space-x-3">
            <button id="cancel-create-auth-btn" class="btn-card h-10 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white">
              å–æ¶ˆ
            </button>
            <button id="confirm-create-auth-btn" class="btn-card h-10 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white">
              ç¡®è®¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- é€‰é¡¹å¡å¯¼èˆª -->
    <div class="border-b border-neutral-200 dark:border-neutral-700 mb-6">
      <nav class="flex space-x-8">
        <button class="tab-btn py-3 px-1 text-left transition-smooth tab-active text-[var(--primary)] font-medium relative" data-target="normalForm">
          <i class="fa fa-file-text mr-2" aria-hidden="true"></i>å¸–å­æ–‡æ¡£
        </button>
        <button class="tab-btn py-3 px-1 text-left text-neutral-500 dark:text-neutral-400 transition-smooth relative" data-target="diaryForm">
          <i class="fa fa-book mr-2" aria-hidden="true"></i>æ—¥è®°æ–‡æ¡£
        </button>
        <button class="tab-btn py-3 px-1 text-left text-neutral-500 dark:text-neutral-400 transition-smooth relative" data-target="albumForm">
          <i class="fa fa-picture-o mr-2" aria-hidden="true"></i>ç›¸å†Œé…ç½®
        </button>
      </nav>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="lg:col-span-1">
        <!-- å¸–å­è¡¨å• -->
        <form id="normalForm" class="form-content space-y-5">
          <div class="space-y-2">
            <label for="normalTitle" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ ‡é¢˜ <span class="text-red-500">*</span></label>
            <input type="text" id="normalTitle" name="normalTitle" required
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ä¸­æ–‡å¸–å­">
          </div>
          <div class="space-y-2">
            <label for="normalPublished" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">å‘å¸ƒæ—¥æœŸ</label>
            <input type="date" id="normalPublished" name="normalPublished"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
          </div>
          <div class="space-y-2">
            <label for="normalDescription" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æè¿°</label>
            <textarea id="normalDescription" name="normalDescription" rows="2"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)] resize-none"
              placeholder="æ·»åŠ æ–‡æ¡£æè¿°ä¿¡æ¯"></textarea>
          </div>
          <div class="space-y-2">
            <label for="normalTags" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
            <input type="text" id="normalTags" name="normalTags"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ä¾‹å¦‚ï¼šè¯—æ­Œï¼Œæµ‹è¯•">
          </div>
          <div class="space-y-2">
            <label for="normalCategory" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">åˆ†ç±»</label>
            <input type="text" id="normalCategory" name="normalCategory"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ä¾‹å¦‚ï¼šåˆ›ä½œ">
          </div>

          <div class="space-y-4 pt-2">
            <div>
              <div class="flex items-center space-x-3 mb-3 pt-1">
                <input type="checkbox" id="normalUseImage" name="normalUseImage"
                  class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
                <label for="normalUseImage" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">æ·»åŠ å°é¢å›¾ç‰‡</label>
              </div>
              <div id="normalImageSection" class="hidden pl-7 space-y-2 fade-in">
                <label for="normalImage" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">å›¾ç‰‡æ–‡ä»¶åï¼ˆå«åç¼€ï¼‰</label>
                <div class="image-input-container">
                  <input type="text" id="normalImage" name="normalImage"
                    class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                    placeholder="ä¾‹å¦‚ï¼šonline.jpg">
                </div>
              </div>
            </div>

            <div class="flex items-center space-x-3 pt-1">
              <input type="checkbox" id="normalPinned" name="normalPinned"
                class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
              <label for="normalPinned" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">ç½®é¡¶å¸–å­</label>
            </div>

            <div class="flex items-center space-x-3 pt-1">
              <input type="checkbox" id="normalDraft" name="normalDraft"
                class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
              <label for="normalDraft" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">è‰ç¨¿æ¨¡å¼</label>
            </div>

            <div class="pt-2">
              <div class="flex items-center space-x-3 mb-3 pt-1">
                <input type="checkbox" id="normalUsePassword" name="normalUsePassword"
                  class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
                <label for="normalUsePassword" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">å¯ç”¨å¯†ç ä¿æŠ¤</label>
              </div>
              <div id="normalPasswordSection" class="hidden pl-7 space-y-2 fade-in">
                <label for="normalPassword" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">å¯†ç </label>
                <div class="image-input-container">
                  <input type="text" id="normalPassword" name="normalPassword" value="666999"
                    class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                    placeholder="è¾“å…¥å¯†ç ">
                </div>
              </div>
            </div>

            <div class="pt-2">
              <div class="flex items-center space-x-3 mb-3 pt-1">
                <input type="checkbox" id="normalUseAuthor" name="normalUseAuthor"
                  class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
                <label for="normalUseAuthor" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">æ·»åŠ ä½œè€…ä¿¡æ¯</label>
              </div>
              <div id="normalAuthorSection" class="hidden pl-7 space-y-2 fade-in">
                <label for="normalAuthor" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">ä½œè€…åç§°</label>
                <div class="image-input-container">
                  <input type="text" id="normalAuthor" name="normalAuthor"
                    class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                    placeholder="è¾“å…¥ä½œè€…åç§°(é»˜è®¤ä¸ºDoulor)">
                </div>
              </div>
            </div>

            <div class="pt-2">
              <div class="flex items-center space-x-3 mb-3 pt-1">
                <input type="checkbox" id="normalUseSource" name="normalUseSource"
                  class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
                <label for="normalUseSource" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">æ·»åŠ æ¥æºé“¾æ¥</label>
              </div>
              <div id="normalSourceSection" class="hidden pl-7 space-y-2 fade-in">
                <label for="normalSource" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ¥æºé“¾æ¥</label>
                <div class="image-input-container">
                  <input type="text" id="normalSource" name="normalSource"
                    class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                    placeholder="è¾“å…¥æ¥æºé“¾æ¥(é»˜è®¤ä¸ºæœ¬ç«™é“¾æ¥)">
                </div>
              </div>
            </div>
          </div>

          <div class="space-y-2 pt-3">
            <label for="normalContent" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ­£æ–‡å†…å®¹</label>
            <textarea id="normalContent" name="normalContent" rows="6"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)] resize-none"
              placeholder="è¯·è¾“å…¥æ–‡æ¡£æ­£æ–‡å†…å®¹..."></textarea>
          </div>
        </form>

        <!-- æ—¥è®°è¡¨å• -->
        <form id="diaryForm" class="form-content space-y-5 hidden">
          <div class="space-y-2">
            <label for="diaryTitle" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ—¥è®°æ ‡é¢˜ <span class="text-red-500">*</span></label>
            <input type="text" id="diaryTitle" name="diaryTitle" required
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ä¸­æ–‡æ—¥è®°">
          </div>
          <div class="space-y-2">
            <label for="diaryDate" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ—¥è®°æ—¥æœŸ</label>
            <input type="date" id="diaryDate" name="diaryDate"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
          </div>
          <div class="pt-2">
            <div class="flex items-center space-x-3 mb-3 pt-1">
              <input type="checkbox" id="diaryUseImage" name="diaryUseImage"
                class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
              <label for="diaryUseImage" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">æ·»åŠ å›¾ç‰‡</label>
            </div>
            <div id="diaryImageSection" class="hidden pl-7 space-y-3 fade-in">
              <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">å›¾ç‰‡ç±»å‹</label>
              <div class="grid grid-cols-2 gap-4 mb-4">
                <label class="flex items-center space-x-3 p-4 border border-neutral-200 dark:border-neutral-700 rounded-lg cursor-pointer hover:bg-[var(--surface-light)] transition-smooth">
                  <input type="radio" name="diaryImageType" value="local" checked
                    class="w-4 h-4 text-[var(--accent)] border-neutral-300 focus:ring-[var(--accent)]">
                  <div>
                    <div class="font-medium text-neutral-700 dark:text-neutral-300">æœ¬åœ°å›¾ç‰‡</div>
                    <div class="text-xs text-neutral-500 dark:text-neutral-400">ä½¿ç”¨æœ¬åœ°å›¾ç‰‡æ–‡ä»¶</div>
                  </div>
                </label>
                <label class="flex items-center space-x-3 p-4 border border-neutral-200 dark:border-neutral-700 rounded-lg cursor-pointer hover:bg-[var(--surface-light)] transition-smooth">
                  <input type="radio" name="diaryImageType" value="r2"
                    class="w-4 h-4 text-[var(--accent)] border-neutral-300 focus:ring-[var(--accent)]">
                  <div>
                    <div class="font-medium text-neutral-700 dark:text-neutral-300">R2å›¾ç‰‡</div>
                    <div class="text-xs text-neutral-500 dark:text-neutral-400">ä»R2å­˜å‚¨è·å–å›¾ç‰‡</div>
                  </div>
                </label>
              </div>

              <!-- R2æ—¥è®°åŠŸèƒ½åŒºåŸŸ -->
              <div id="r2DiarySection" class="hidden space-y-3 pt-4">
                <h3 class="text-lg font-semibold text-neutral-700 dark:text-neutral-300 mb-3 flex items-center">
                  <i class="fa fa-cloud mr-2 text-blue-500" aria-hidden="true"></i>R2 æ—¥è®°å›¾ç‰‡åŠŸèƒ½
                </h3>
                <div class="space-y-3">
                  <div class="space-y-2">
                    <label for="diaryR2WorkerUrl" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">Worker URL</label>
                    <input type="text" id="diaryR2WorkerUrl"
                        class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                        placeholder="ä¾‹å¦‚: https://r2img.firef.dpdns.org"
                        value="https://r2img.firef.dpdns.org">
                  </div>
                  <div class="space-y-2">
                    <label for="diaryR2Directory" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">R2 ç›®å½•å</label>
                    <input type="text" id="diaryR2Directory"
                        class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                        placeholder="ä¾‹å¦‚: happyday (è‡ªåŠ¨è¯†åˆ«ä¸º diary/happyday)">
                  </div>
                  <button type="button" id="fetchDiaryR2ImagesBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-smooth flex items-center">
                    <i class="fa fa-sync mr-2" aria-hidden="true"></i>è·å– R2 å›¾ç‰‡é“¾æ¥
                  </button>
                </div>
              </div>

              <!-- æœ¬åœ°å›¾ç‰‡è¾“å…¥åŒºåŸŸ -->
              <div id="localDiaryImageSection">
                <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">å›¾ç‰‡æ–‡ä»¶åæˆ–å¤–éƒ¨é“¾æ¥</label>
                <div id="diaryImagesContainer" class="space-y-2">
                </div>
                <button type="button" id="addImageBtn" class="text-sm bg-[var(--secondary)]/20 hover:bg-[var(--secondary)] text-[var(--secondary)] hover:text-white px-4 py-2 rounded-lg transition-smooth flex items-center border border-[var(--secondary)]/30 hover:border-[var(--secondary)] mt-2">
                  <i class="fa fa-plus mr-1" aria-hidden="true"></i> æ·»åŠ å›¾ç‰‡
                </button>
              </div>
            </div>
          </div>
          <div class="space-y-2 pt-2">
            <label for="diaryContent" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ—¥è®°å†…å®¹</label>
            <textarea id="diaryContent" name="diaryContent" rows="8"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)] resize-none"
              placeholder="ä»Šå¤©å¤©æ°”å¾ˆå¥½..."></textarea>
          </div>
        </form>

        <!-- ç›¸å†Œè¡¨å• -->
        <form id="albumForm" class="form-content space-y-5 hidden">
          <div class="space-y-2">
            <label for="albumTitle" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">ç›¸å†Œæ ‡é¢˜ <span class="text-red-500">*</span></label>
            <input type="text" id="albumTitle" name="albumTitle" required
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„æ—…è¡Œç›¸å†Œ">
          </div>
          <div class="space-y-2">
            <label for="albumDate" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">åˆ›å»ºæ—¥æœŸ</label>
            <input type="date" id="albumDate" name="albumDate"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
          </div>
          <div class="space-y-2">
            <label for="albumDescription" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">ç›¸å†Œæè¿°</label>
            <textarea id="albumDescription" name="albumDescription" rows="2"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)] resize-none"
              placeholder="æè¿°è¿™ä¸ªç›¸å†Œçš„å†…å®¹..."></textarea>
          </div>
          <div class="space-y-2">
            <label for="albumLocation" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ‹æ‘„åœ°ç‚¹</label>
            <input type="text" id="albumLocation" name="albumLocation"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬ï¼Œä¸œäº¬">
          </div>
          <div class="space-y-2">
            <label for="albumTags" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
            <input type="text" id="albumTags" name="albumTags"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ä¾‹å¦‚ï¼šæ—…è¡Œï¼Œé£æ™¯ï¼Œæ—¥æœ¬">
          </div>

          <div class="space-y-4 pt-2">
            <div class="flex items-center space-x-3 pt-1">
              <input type="checkbox" id="albumHidden" name="albumHidden"
                class="w-5 h-5 text-[var(--primary)] border-2 border-neutral-300 dark:border-neutral-600 rounded focus:ring-[var(--primary)] focus:ring-offset-0 cursor-pointer transition-all duration-200 hover:scale-110">
              <label for="albumHidden" class="text-sm font-medium text-neutral-700 dark:text-neutral-300 select-none cursor-pointer">éšè—ç›¸å†Œ</label>
            </div>
          </div>

          <!-- ç›¸å†Œå¸ƒå±€ -->
          <div class="space-y-2 pt-4">
            <label for="albumLayout" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">å¸ƒå±€æ–¹å¼</label>
            <select id="albumLayout" name="albumLayout"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
              <option value="grid">ç½‘æ ¼å¸ƒå±€</option>
              <option value="masonry">ç€‘å¸ƒæµå¸ƒå±€</option>
            </select>
          </div>

          <!-- åˆ—æ•° -->
          <div class="space-y-2 pt-2">
            <label for="albumColumns" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">åˆ—æ•°</label>
            <input type="number" id="albumColumns" name="albumColumns" min="1" max="4" value="3"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
          </div>

          <!-- å°é¢å›¾ç‰‡ -->
          <div class="space-y-2 pt-2">
            <label for="albumCover" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">å°é¢å›¾ç‰‡è·¯å¾„</label>
            <input type="text" id="albumCover" name="albumCover"
              class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              placeholder="ç›¸å†Œå°é¢å›¾ç‰‡è·¯å¾„ï¼Œå¦‚ï¼š/images/albums/album-name/cover.jpg">
          </div>

          <div class="pt-3">
            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-3">ç›¸å†Œç±»å‹</label>
            <div class="grid grid-cols-3 gap-4">
              <label class="flex items-center space-x-3 p-4 border border-neutral-200 dark:border-neutral-700 rounded-lg cursor-pointer hover:bg-[var(--surface-light)] transition-smooth">
                <input type="radio" name="albumType" value="local" checked
                  class="w-4 h-4 text-[var(--accent)] border-neutral-300 focus:ring-[var(--accent)]">
                <div>
                  <div class="font-medium text-neutral-700 dark:text-neutral-300">æœ¬åœ°ç›¸å†Œ</div>
                  <div class="text-xs text-neutral-500 dark:text-neutral-400">ä¸Šä¼ å›¾ç‰‡åˆ°æœ¬åœ°å›¾åº“</div>
                </div>
              </label>
              <label class="flex items-center space-x-3 p-4 border border-neutral-200 dark:border-neutral-700 rounded-lg cursor-pointer hover:bg-[var(--surface-light)] transition-smooth">
                <input type="radio" name="albumType" value="external"
                  class="w-4 h-4 text-[var(--accent)] border-neutral-300 focus:ring-[var(--accent)]">
                <div>
                  <div class="font-medium text-neutral-700 dark:text-neutral-300">å¤–éƒ¨ç›¸å†Œ</div>
                  <div class="text-xs text-neutral-500 dark:text-neutral-400">ä½¿ç”¨å¤–éƒ¨å›¾ç‰‡é“¾æ¥</div>
                </div>
              </label>
              <label class="flex items-center space-x-3 p-4 border border-neutral-200 dark:border-neutral-700 rounded-lg cursor-pointer hover:bg-[var(--surface-light)] transition-smooth">
                <input type="radio" name="albumType" value="r2"
                  class="w-4 h-4 text-[var(--accent)] border-neutral-300 focus:ring-[var(--accent)]">
                <div>
                  <div class="font-medium text-neutral-700 dark:text-neutral-300">R2ç›¸å†Œ</div>
                  <div class="text-xs text-neutral-500 dark:text-neutral-400">ä»R2å­˜å‚¨è·å–å›¾ç‰‡</div>
                </div>
              </label>
            </div>
          </div>

          <!-- R2ç›¸å†ŒåŠŸèƒ½åŒºåŸŸ -->
          <div id="r2AlbumSection" class="hidden space-y-3 pt-4">
            <h3 class="text-lg font-semibold text-neutral-700 dark:text-neutral-300 mb-3 flex items-center">
              <i class="fa fa-cloud mr-2 text-blue-500" aria-hidden="true"></i>R2 ç›¸å†ŒåŠŸèƒ½
            </h3>
            <div class="space-y-3">
              <div class="space-y-2">
                <label for="r2WorkerUrl" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">Worker URL</label>
                <input type="text" id="r2WorkerUrl"
                    class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                    placeholder="ä¾‹å¦‚: https://r2img.firef.dpdns.org"
                    value="https://r2img.firef.dpdns.org">
              </div>
              <div class="space-y-2">
                <label for="r2Directory" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">R2 ç›®å½•å</label>
                <input type="text" id="r2Directory"
                    class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
                    placeholder="ä¾‹å¦‚: sky (è‡ªåŠ¨è¯†åˆ«ä¸º album/sky)">
              </div>
              <button type="button" id="fetchR2ImagesBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-smooth flex items-center">
                <i class="fa fa-sync mr-2" aria-hidden="true"></i>è·å– R2 å›¾ç‰‡é“¾æ¥
              </button>
            </div>
          </div>

          <div id="externalAlbumSection" class="hidden space-y-3 pt-4">
            <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">ç›¸å†Œå›¾ç‰‡ <small class="text-neutral-500 dark:text-neutral-400">(å¤–éƒ¨é“¾æ¥)</small></label>
            <div id="photosContainer" class="space-y-2">
            </div>
            <button type="button" id="addPhotoBtn" class="text-sm bg-[var(--accent)]/20 hover:bg-[var(--accent)] text-[var(--accent)] hover:text-white px-4 py-2 rounded-lg transition-smooth flex items-center border border-[var(--accent)]/30 hover:border-[var(--accent)]">
              <i class="fa fa-plus mr-2" aria-hidden="true"></i> æ·»åŠ å›¾ç‰‡
            </button>
          </div>
        </form>
      </div>

      <!-- ç»“æœå’Œæ§åˆ¶é¢æ¿ -->
      <div class="lg:col-span-1">
        <div class="card-base p-5">
          <div class="border-b border-neutral-200 dark:border-neutral-700 pb-4 mb-6">
            <h2 class="text-xl font-semibold text-neutral-900 dark:text-neutral-100 flex items-center">
              <i class="fa fa-code mr-2" aria-hidden="true"></i>ç”Ÿæˆç»“æœ
            </h2>
            <p class="text-sm text-neutral-600 dark:text-neutral-400 mt-1">ç”Ÿæˆçš„Frontmatteræ–‡æ¡£æ ¼å¼ï¼Œå¯ç›´æ¥ç”¨äºåšå®¢</p>
          </div>

          <div class="space-y-4">
            <div>
              <label for="fileName" class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">æ–‡ä»¶å</label>
              <input type="text" id="fileName" placeholder="ä¾‹å¦‚ï¼š2025-01-01-my-post.md"
                class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
              <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">è¯·åŒ…å«æ­£ç¡®çš„æ–‡ä»¶æ‰©å±•å(.md)å’Œæ—¥æœŸå‰ç¼€</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2">æ–‡ä»¶è·¯å¾„</label>
              <div class="flex space-x-2">
                <select id="fileDirectory" class="flex-1 p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
                  <option value="src/content/posts">æ–‡ç«  (src/content/posts)</option>
                  <option value="src/content/diary">æ—¥è®° (src/content/diary)</option>
                  <option value="src/content/albums">ç›¸å†Œ (src/content/albums)</option>
                </select>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-2 flex justify-between items-center">
                <span>ç”Ÿæˆçš„å†…å®¹</span>
                <button id="copyButton" class="text-sm bg-neutral-100 hover:bg-neutral-200 dark:bg-neutral-700 dark:hover:bg-neutral-600 text-neutral-700 dark:text-neutral-200 px-3 py-1 rounded transition-smooth flex items-center">
                  <i class="fa fa-copy mr-1" aria-hidden="true"></i>å¤åˆ¶
                </button>
              </label>
              <pre id="markdownResult" class="bg-neutral-50 dark:bg-neutral-800/50 border border-neutral-200 dark:border-neutral-700 rounded p-4 text-sm font-mono whitespace-pre-wrap overflow-x-auto max-h-96 overflow-y-auto"></pre>
            </div>

            <div class="pt-4">
              <button id="saveToGithub" class="w-full btn-card h-12 rounded-lg bg-gradient-to-r from-green-600 to-green-700 text-white border-2 border-green-600 hover:border-green-800 transition-all duration-200 hover:shadow-[0_4px_12px_rgba(16,185,129,0.2)]">
                <i class="fa fa-github mr-2" aria-hidden="true"></i>æäº¤åˆ° GitHub ä»“åº“
              </button>
              <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-2 text-center">éœ€è¦å…ˆå®Œæˆ GitHub è®¤è¯</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æäº¤å®Œæˆå¼¹çª— -->
  <div id="submitModal" class="fixed inset-0 bg-black bg-opacity-0 flex items-center justify-center z-50 hidden transition-opacity duration-300">
    <div class="bg-white dark:bg-neutral-800 rounded-xl p-8 w-full max-w-md shadow-2xl mx-4 transform scale-95 transition-all duration-300 opacity-0">
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 dark:bg-green-900/30 mb-4">
          <i class="fa fa-check text-green-600 dark:text-green-400 text-2xl" aria-hidden="true"></i>
        </div>
        <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">æäº¤æˆåŠŸ</h3>
        <p class="text-neutral-600 dark:text-neutral-400 mb-6">å†…å®¹å·²æˆåŠŸæäº¤åˆ°GitHubä»“åº“ï¼</p>
        <div class="flex justify-end">
          <button id="closeModalBtn" class="btn-card h-12 px-6 rounded-lg bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white">
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>
  </div>
</MainGridLayout>

<script>
  // ç®¡ç†è®¤è¯çŠ¶æ€
  let githubToken = localStorage.getItem('github_access_token') || null;

  // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
  function updateCreateAuthStatus() {
    const authStatusText = document.getElementById('create-auth-status-text');
    const authStatusIndicator = document.getElementById('create-auth-status-indicator');
    const authBtnText = document.getElementById('create-auth-btn-text');

    if (githubToken) {
      authStatusText.textContent = 'å·²è®¤è¯';
      authStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
      authBtnText.textContent = 'é€€å‡º';
    } else {
      authStatusText.textContent = 'æœªè®¤è¯';
      authStatusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
      authBtnText.textContent = 'ç™»å½•';
    }
  }

  // æ˜¾ç¤ºæ¶ˆæ¯
  function showMessage(message, type = 'info') {
    const messageArea = document.getElementById('message-area');
    const infoMessage = document.getElementById('info-message');
    const errorMessage = document.getElementById('error-message');

    messageArea.classList.remove('hidden');

    if (type === 'info') {
      infoMessage.textContent = message;
      infoMessage.classList.remove('hidden');
      errorMessage.classList.add('hidden');
    } else if (type === 'error') {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      infoMessage.classList.add('hidden');
    }

    // 3ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
    setTimeout(() => {
      messageArea.classList.add('hidden');
    }, 3000);
  }

  // åˆå§‹åŒ–é€‰é¡¹å¡
  function initTabs() {
    // ç¡®ä¿ç¬¬ä¸€ä¸ªé€‰é¡¹å¡æœ‰æ¿€æ´»çŠ¶æ€å’ŒæŒ‡ç¤ºçº¿
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('tab-active', 'text-[var(--primary)]', 'font-medium');
      btn.classList.add('text-neutral-500', 'dark:text-neutral-400');
      // ç§»é™¤ä»»ä½•ç°æœ‰çš„æŒ‡ç¤ºçº¿
      const existingIndicators = btn.getElementsByClassName('tab-indicator');
      // Convert HTMLCollection to array to safely remove elements
      Array.from(existingIndicators).forEach(indicator => indicator.remove());
    });

    // ä¸ºç¬¬ä¸€ä¸ªæ ‡ç­¾æ·»åŠ æ¿€æ´»çŠ¶æ€å’ŒæŒ‡ç¤ºçº¿
    const firstTab = document.querySelector('.tab-btn[data-target="normalForm"]');
    if (firstTab) {
      firstTab.classList.add('tab-active', 'text-[var(--primary)]', 'font-medium');
      firstTab.classList.remove('text-neutral-500', 'dark:text-neutral-400');

      const indicator = document.createElement('div');
      indicator.className = 'tab-indicator absolute bottom-0 left-0 w-full h-0.5 bg-[var(--primary)]';
      firstTab.appendChild(indicator);
    }
  }

  // åˆ‡æ¢é€‰é¡¹å¡
  function switchTab(activeButton) {
    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€å’ŒæŒ‡ç¤ºçº¿
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('tab-active', 'text-[var(--primary)]', 'font-medium');
      btn.classList.add('text-neutral-500', 'dark:text-neutral-400');
      // ç§»é™¤æ‰€æœ‰æŒ‡ç¤ºçº¿
      const existingIndicators = btn.getElementsByClassName('tab-indicator');
      // Convert HTMLCollection to array to safely remove elements
      Array.from(existingIndicators).forEach(indicator => indicator.remove());
    });

    // å¯¹å½“å‰æŒ‰é’®æ·»åŠ æ´»åŠ¨çŠ¶æ€å’ŒæŒ‡ç¤ºçº¿
    activeButton.classList.add('tab-active', 'text-[var(--primary)]', 'font-medium');
    activeButton.classList.remove('text-neutral-500', 'dark:text-neutral-400');

    const indicator = document.createElement('div');
    indicator.className = 'tab-indicator absolute bottom-0 left-0 w-full h-0.5 bg-[var(--primary)]';
    activeButton.appendChild(indicator);
  }

  // é€‰é¡¹å¡åˆ‡æ¢åŠŸèƒ½
  document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
      // åˆ‡æ¢æ¿€æ´»çŠ¶æ€
      switchTab(button);

      // è·å–ç›®æ ‡è¡¨å•
      const target = button.getAttribute('data-target');
      const targetForm = document.getElementById(target);

      // è·å–å½“å‰æ˜¾ç¤ºçš„è¡¨å•
      const currentForm = document.querySelector('.form-content:not(.hidden):not(.fade-out)');

      // å¦‚æœæœ‰å½“å‰è¡¨å•æ­£åœ¨æ˜¾ç¤ºï¼Œåˆ™å…ˆæ·¡å‡º
      if (currentForm && currentForm !== targetForm) {
        currentForm.classList.add('fade-out');
        setTimeout(() => {
          currentForm.classList.add('hidden');
          currentForm.classList.remove('fade-out');

          // ç„¶åæ·¡å…¥ç›®æ ‡è¡¨å•
          targetForm.classList.remove('hidden');
          setTimeout(() => {
            targetForm.classList.add('fade-in');

            // éšè—å®Œæˆåç”ŸæˆMarkdown
            setTimeout(() => {
              const formType = target.replace('Form', '');
              generateMarkdown(formType);
            }, 300);
          }, 1);
        }, 300);
      } else {
        // å¦‚æœæ²¡æœ‰å½“å‰è¡¨å•ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰æˆ–ç‚¹å‡»çš„æ˜¯å½“å‰è¡¨å•ï¼Œç›´æ¥æ˜¾ç¤ºç›®æ ‡è¡¨å•
        document.querySelectorAll('.form-content').forEach(form => {
          if (form !== targetForm) {
            form.classList.add('hidden');
          }
        });
        targetForm.classList.remove('hidden');
        targetForm.classList.add('fade-in');

        const formType = target.replace('Form', '');
        generateMarkdown(formType);

        // æ·»åŠ å®Œæˆåç§»é™¤fade-inç±»ï¼Œä»¥é˜²æ­¢é‡å¤åŠ¨ç”»
        setTimeout(() => {
          if (targetForm.classList.contains('fade-in')) {
            targetForm.classList.remove('fade-in');
          }
        }, 300);
      }
    });
  });

  // é¡µé¢åŠ è½½ååˆå§‹åŒ–é€‰é¡¹å¡
  document.addEventListener('DOMContentLoaded', initTabs);

  // ä¸ºå¤é€‰æ¡†æ·»åŠ ç›‘å¬
  const checkboxes = document.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }
    });
  });

  // å¤„ç†å¸–å­å°é¢å›¾ç‰‡æ˜¾ç¤º/éšè—
  document.getElementById('normalUseImage').addEventListener('change', function() {
    const section = document.getElementById('normalImageSection');
    if(this.checked) {
      section.classList.remove('hidden');
      setTimeout(() => {
        section.classList.add('fade-in');
      }, 1);
    } else {
      section.classList.add('fade-out');
      setTimeout(() => {
        section.classList.add('hidden');
        section.classList.remove('fade-out');
      }, 300);
    }
  });

  // å¤„ç†å¸–å­å¯†ç ä¿æŠ¤æ˜¾ç¤º/éšè—
  document.getElementById('normalUsePassword').addEventListener('change', function() {
    const section = document.getElementById('normalPasswordSection');
    if(this.checked) {
      section.classList.remove('hidden');
      setTimeout(() => {
        section.classList.add('fade-in');
      }, 1);
    } else {
      section.classList.add('fade-out');
      setTimeout(() => {
        section.classList.add('hidden');
        section.classList.remove('fade-out');
      }, 300);
    }
  });

  // å¤„ç†å¸–å­ä½œè€…ä¿¡æ¯æ˜¾ç¤º/éšè—
  document.getElementById('normalUseAuthor').addEventListener('change', function() {
    const section = document.getElementById('normalAuthorSection');
    if(this.checked) {
      section.classList.remove('hidden');
      setTimeout(() => {
        section.classList.add('fade-in');
      }, 1);
    } else {
      section.classList.add('fade-out');
      setTimeout(() => {
        section.classList.add('hidden');
        section.classList.remove('fade-out');
      }, 300);
    }
  });

  // å¤„ç†å¸–å­æ¥æºé“¾æ¥æ˜¾ç¤º/éšè—
  document.getElementById('normalUseSource').addEventListener('change', function() {
    const section = document.getElementById('normalSourceSection');
    if(this.checked) {
      section.classList.remove('hidden');
      setTimeout(() => {
        section.classList.add('fade-in');
      }, 1);
    } else {
      section.classList.add('fade-out');
      setTimeout(() => {
        section.classList.add('hidden');
        section.classList.remove('fade-out');
      }, 300);
    }

    // è§¦å‘ç”Ÿæˆé¢„è§ˆä»¥æ›´æ–°é“¾æ¥
    const activeForm = document.querySelector('.form-content:not(.hidden)');
    if (activeForm) {
      const formType = activeForm.id.replace('Form', '');
      generateMarkdown(formType);
    }
  });

  // ç›‘å¬æ¥æºé“¾æ¥è¾“å…¥æ¡†ï¼Œè§¦å‘é¢„è§ˆæ›´æ–°
  document.getElementById('normalSource').addEventListener('input', function() {
    // è§¦å‘ç”Ÿæˆé¢„è§ˆ
    const activeForm = document.querySelector('.form-content:not(.hidden)');
    if (activeForm) {
      const formType = activeForm.id.replace('Form', '');
      generateMarkdown(formType);
    }
  });

  // æ·»åŠ æ—¥è®°å›¾ç‰‡è¾“å…¥æ¡†çš„å‡½æ•°
  function addDiaryImageInput() {
    const container = document.getElementById('diaryImagesContainer');
    const inputDiv = document.createElement('div');
    inputDiv.className = 'diary-image-input fade-in flex items-center gap-2 mb-2 image-input-container';
    inputDiv.innerHTML = `
        <input type="text" name="diaryImage[]" placeholder="å›¾ç‰‡æ–‡ä»¶åæˆ–å¤–éƒ¨é“¾æ¥"
            class="flex-1 p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
        <button type="button" class="remove-image bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-800 text-red-600 dark:text-red-300 w-10 h-10 rounded-full flex items-center justify-center transition-smooth">
            <span class="text-xl font-bold">ğŸ—‘</span>
        </button>
    `;
    container.appendChild(inputDiv);

    // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨æ¥å®æ—¶æ›´æ–°å†…å®¹
    const inputField = inputDiv.querySelector('input');
    inputField.addEventListener('input', function() {
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }
    });

    // æ·»åŠ åˆ é™¤åŠŸèƒ½
    inputDiv.querySelector('.remove-image').addEventListener('click', function() {
      const item = this.parentElement;
      item.classList.add('fade-out');
      setTimeout(() => {
        item.remove();
        // åˆ é™¤åæ›´æ–°ç”Ÿæˆçš„å†…å®¹
        const activeForm = document.querySelector('.form-content:not(.hidden)');
        if (activeForm) {
          const formType = activeForm.id.replace('Form', '');
          generateMarkdown(formType);
        }
      }, 300);
    });
  }

  // å¤„ç†æ—¥è®°å›¾ç‰‡æ˜¾ç¤º/éšè—ï¼Œå¹¶è‡ªåŠ¨æ·»åŠ ä¸€ä¸ªå›¾ç‰‡è¾“å…¥æ¡†
  document.getElementById('diaryUseImage').addEventListener('change', function() {
    const section = document.getElementById('diaryImageSection');
    const container = document.getElementById('diaryImagesContainer');

    if(this.checked) {
      section.classList.remove('hidden');
      setTimeout(() => {
        section.classList.add('fade-in');

        // å¦‚æœæ²¡æœ‰å›¾ç‰‡è¾“å…¥æ¡†ï¼Œåˆ™æ·»åŠ ä¸€ä¸ª
        if (container.children.length === 0) {
          addDiaryImageInput();
        }
      }, 1);
    } else {
      section.classList.add('fade-out');
      setTimeout(() => {
        section.classList.add('hidden');
        section.classList.remove('fade-out');
        // æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡è¾“å…¥æ¡†
        container.innerHTML = '';
      }, 300);
    }
  });

  // å¤„ç†æ—¥è®°æ·»åŠ å›¾ç‰‡åŠŸèƒ½
  document.getElementById('addImageBtn').addEventListener('click', function() {
    const container = document.getElementById('diaryImagesContainer');
    const inputDiv = document.createElement('div');
    inputDiv.className = 'diary-image-input fade-in flex items-center gap-2 mb-2 image-input-container';
    inputDiv.innerHTML = `
        <input type="text" name="diaryImage[]" placeholder="å›¾ç‰‡æ–‡ä»¶åæˆ–å¤–éƒ¨é“¾æ¥"
            class="flex-1 p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
        <button type="button" class="remove-image bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-800 text-red-600 dark:text-red-300 w-10 h-10 rounded-full flex items-center justify-center transition-smooth">
            <span class="text-xl font-bold">ğŸ—‘</span>
        </button>
    `;
    container.appendChild(inputDiv);

    // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨æ¥å®æ—¶æ›´æ–°å†…å®¹
    const inputField = inputDiv.querySelector('input');
    inputField.addEventListener('input', function() {
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }
    });

    // æ·»åŠ åˆ é™¤åŠŸèƒ½
    inputDiv.querySelector('.remove-image').addEventListener('click', function() {
      const item = this.parentElement;
      item.classList.add('fade-out');
      setTimeout(() => {
        item.remove();
        // åˆ é™¤åæ›´æ–°ç”Ÿæˆçš„å†…å®¹
        const activeForm = document.querySelector('.form-content:not(.hidden)');
        if (activeForm) {
          const formType = activeForm.id.replace('Form', '');
          generateMarkdown(formType);
        }
      }, 300);
    });
  });

  // ä¸ºå•é€‰æŒ‰é’®æ·»åŠ ç›‘å¬
  const radios = document.querySelectorAll('input[type="radio"]');
  radios.forEach(radio => {
    radio.addEventListener('change', function() {
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }
    });
  });

  // æ·»åŠ ç›¸å†Œå›¾ç‰‡è¾“å…¥æ¡†çš„å‡½æ•°
  function addAlbumImageInput() {
    const container = document.getElementById('photosContainer');
    const inputDiv = document.createElement('div');
    inputDiv.className = 'album-image-input fade-in flex items-center gap-2 mb-2 image-input-container';
    inputDiv.innerHTML = `
        <input type="text" name="photoSrc[]" placeholder="å›¾ç‰‡é“¾æ¥"
            class="flex-1 p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
        <button type="button" class="remove-photo bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-800 text-red-600 dark:text-red-300 w-10 h-10 rounded-full flex items-center justify-center transition-smooth">
            <span class="text-xl font-bold">Ã—</span>
        </button>
    `;
    container.appendChild(inputDiv);

    // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨æ¥å®æ—¶æ›´æ–°å†…å®¹
    const inputField = inputDiv.querySelector('input');
    inputField.addEventListener('input', function() {
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }
    });

    // æ·»åŠ åˆ é™¤åŠŸèƒ½
    inputDiv.querySelector('.remove-photo').addEventListener('click', function() {
      const item = this.parentElement;
      item.classList.add('fade-out');
      setTimeout(() => {
        item.remove();
        // åˆ é™¤åæ›´æ–°ç”Ÿæˆçš„å†…å®¹
        const activeForm = document.querySelector('.form-content:not(.hidden)');
        if (activeForm) {
          const formType = activeForm.id.replace('Form', '');
          generateMarkdown(formType);
        }
      }, 300);
    });
  }

  // ç›¸å†Œç±»å‹åˆ‡æ¢
  document.querySelectorAll('input[name="albumType"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const localSection = document.getElementById('externalAlbumSection'); // ç”¨äºéšè—å¤–éƒ¨ç›¸å†Œéƒ¨åˆ†
      const r2Section = document.getElementById('r2AlbumSection');
      const container = document.getElementById('photosContainer');

      // éšè—æ‰€æœ‰å¤–éƒ¨ç›¸å…³éƒ¨åˆ†
      document.getElementById('externalAlbumSection').classList.add('hidden');
      document.getElementById('externalAlbumSection').classList.remove('fade-in');
      document.getElementById('r2AlbumSection').classList.add('hidden');
      document.getElementById('r2AlbumSection').classList.remove('fade-in');

      if(this.value === 'external') {
        document.getElementById('externalAlbumSection').classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('externalAlbumSection').classList.add('fade-in');

          // å¦‚æœæ²¡æœ‰å›¾ç‰‡è¾“å…¥æ¡†ï¼Œåˆ™æ·»åŠ ä¸€ä¸ª
          if (container.children.length === 0) {
            addAlbumImageInput();
          }
        }, 1);
      } else if(this.value === 'r2') {
        document.getElementById('externalAlbumSection').classList.remove('hidden');
        r2Section.classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('externalAlbumSection').classList.add('fade-in');
          r2Section.classList.add('fade-in');

          // å¦‚æœæ²¡æœ‰å›¾ç‰‡è¾“å…¥æ¡†ï¼Œåˆ™æ¸…ç©ºï¼ˆR2å›¾ç‰‡é€šè¿‡è·å–æŒ‰é’®æ·»åŠ ï¼‰
          container.innerHTML = '';
        }, 1);
      }
    });
  });

  // æ—¥è®°å›¾ç‰‡ç±»å‹åˆ‡æ¢
  document.querySelectorAll('input[name="diaryImageType"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const r2Section = document.getElementById('r2DiarySection');
      const localSection = document.getElementById('localDiaryImageSection');
      const diaryImagesContainer = document.getElementById('diaryImagesContainer');

      if(this.value === 'r2') {
        r2Section.classList.remove('hidden');
        setTimeout(() => {
          r2Section.classList.add('fade-in');
          // æ¸…ç©ºæœ¬åœ°å›¾ç‰‡è¾“å…¥æ¡†ï¼Œå› ä¸ºR2å›¾ç‰‡é€šè¿‡è·å–æŒ‰é’®æ·»åŠ 
          diaryImagesContainer.innerHTML = '';
        }, 1);
      } else {
        r2Section.classList.add('hidden');
        r2Section.classList.remove('fade-in');
      }
    });
  });

  // æ·»åŠ ä»R2è·å–ç›¸å†Œå›¾ç‰‡é“¾æ¥çš„åŠŸèƒ½
  document.getElementById('fetchR2ImagesBtn').addEventListener('click', async function() {
    const workerUrl = document.getElementById('r2WorkerUrl').value.trim();
    let directory = document.getElementById('r2Directory').value.trim();

    if (!workerUrl || !directory) {
      showMessage('è¯·å¡«å†™Worker URLå’ŒR2ç›®å½•å', 'error');
      return;
    }

    // ä¸ºç›¸å†Œæ·»åŠ è·¯å¾„å‰ç¼€ï¼ˆä»…å½“ç”¨æˆ·è¾“å…¥ç®€çŸ­åç§°ä¸”æœªæŒ‡å®šè·¯å¾„å‰ç¼€æ—¶ï¼‰
    if (!directory.includes('/')) {
      // å¦‚æœç”¨æˆ·è¾“å…¥æ²¡æœ‰åŒ…å«ä»»ä½•æ–œæ ï¼Œå‡è®¾è¿™æ˜¯ä¸€ä¸ªç®€çŸ­ç›®å½•åï¼Œæ·»åŠ  album/ å‰ç¼€
      directory = 'album/' + directory;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const originalText = this.innerHTML;
    this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2" aria-hidden="true"></i>åŠ è½½ä¸­...';
    this.disabled = true;

    try {
      const response = await fetch(`${workerUrl}?dir=${encodeURIComponent(directory)}`);

      if (!response.ok) {
        throw new Error(`è·å–å›¾ç‰‡å¤±è´¥: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();

      if (!Array.isArray(data)) {
        throw new Error('è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      }

      // è·å–å›¾ç‰‡é“¾æ¥åˆ—è¡¨
      const imageUrls = data.map(item => item.url);

      if (imageUrls.length === 0) {
        showMessage('è¯¥ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡', 'info');
        return;
      }

      // æ¸…ç©ºç°æœ‰çš„å›¾ç‰‡è¾“å…¥æ¡†
      const container = document.getElementById('photosContainer');
      container.innerHTML = '';

      // æ·»åŠ ä»R2è·å–åˆ°çš„å›¾ç‰‡é“¾æ¥
      imageUrls.forEach(url => {
        const inputDiv = document.createElement('div');
        inputDiv.className = 'album-image-input fade-in flex items-center gap-2 mb-2 image-input-container';
        inputDiv.innerHTML = `
            <input type="text" name="photoSrc[]" value="${url}" placeholder="å›¾ç‰‡é“¾æ¥"
                class="flex-1 p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
            <button type="button" class="remove-photo bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-800 text-red-600 dark:text-red-300 w-10 h-10 rounded-full flex items-center justify-center transition-smooth">
                <span class="text-xl font-bold">Ã—</span>
            </button>
        `;
        container.appendChild(inputDiv);

        // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨æ¥å®æ—¶æ›´æ–°å†…å®¹
        const inputField = inputDiv.querySelector('input');
        inputField.addEventListener('input', function() {
          const activeForm = document.querySelector('.form-content:not(.hidden)');
          if (activeForm) {
            const formType = activeForm.id.replace('Form', '');
            generateMarkdown(formType);
          }
        });

        // æ·»åŠ åˆ é™¤åŠŸèƒ½
        inputDiv.querySelector('.remove-photo').addEventListener('click', function() {
          const item = this.parentElement;
          item.classList.add('fade-out');
          setTimeout(() => {
            item.remove();
            // åˆ é™¤åæ›´æ–°ç”Ÿæˆçš„å†…å®¹
            const activeForm = document.querySelector('.form-content:not(.hidden)');
            if (activeForm) {
              const formType = activeForm.id.replace('Form', '');
              generateMarkdown(formType);
            }
          }, 300);
        });
      });

      // æ›´æ–°é¢„è§ˆ
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }

      showMessage(`æˆåŠŸè·å–åˆ° ${imageUrls.length} å¼ å›¾ç‰‡é“¾æ¥`, 'info');
    } catch (error) {
      console.error('è·å–R2å›¾ç‰‡é“¾æ¥å¤±è´¥:', error);
      showMessage(`è·å–R2å›¾ç‰‡é“¾æ¥å¤±è´¥: ${error.message}`, 'error');
    } finally {
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      this.innerHTML = originalText;
      this.disabled = false;
    }
  });

  // æ·»åŠ ä»R2è·å–æ—¥è®°å›¾ç‰‡é“¾æ¥çš„åŠŸèƒ½
  document.getElementById('fetchDiaryR2ImagesBtn').addEventListener('click', async function() {
    const workerUrl = document.getElementById('diaryR2WorkerUrl').value.trim();
    let directory = document.getElementById('diaryR2Directory').value.trim();

    if (!workerUrl || !directory) {
      showMessage('è¯·å¡«å†™Worker URLå’ŒR2ç›®å½•å', 'error');
      return;
    }

    // ä¸ºæ—¥è®°æ·»åŠ è·¯å¾„å‰ç¼€ï¼ˆä»…å½“ç”¨æˆ·è¾“å…¥ç®€çŸ­åç§°ä¸”æœªæŒ‡å®šè·¯å¾„å‰ç¼€æ—¶ï¼‰
    if (!directory.includes('/')) {
      // å¦‚æœç”¨æˆ·è¾“å…¥æ²¡æœ‰åŒ…å«ä»»ä½•æ–œæ ï¼Œå‡è®¾è¿™æ˜¯ä¸€ä¸ªç®€çŸ­ç›®å½•åï¼Œæ·»åŠ  diary/ å‰ç¼€
      directory = 'diary/' + directory;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const originalText = this.innerHTML;
    this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2" aria-hidden="true"></i>åŠ è½½ä¸­...';
    this.disabled = true;

    try {
      const response = await fetch(`${workerUrl}?dir=${encodeURIComponent(directory)}`);

      if (!response.ok) {
        throw new Error(`è·å–å›¾ç‰‡å¤±è´¥: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();

      if (!Array.isArray(data)) {
        throw new Error('è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
      }

      // è·å–å›¾ç‰‡é“¾æ¥åˆ—è¡¨
      const imageUrls = data.map(item => item.url);

      if (imageUrls.length === 0) {
        showMessage('è¯¥ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡', 'info');
        return;
      }

      // æ¸…ç©ºç°æœ‰çš„å›¾ç‰‡è¾“å…¥æ¡†
      const container = document.getElementById('diaryImagesContainer');
      container.innerHTML = '';

      // æ·»åŠ ä»R2è·å–åˆ°çš„å›¾ç‰‡é“¾æ¥
      imageUrls.forEach(url => {
        const inputDiv = document.createElement('div');
        inputDiv.className = 'diary-image-input fade-in flex items-center gap-2 mb-2 image-input-container';
        inputDiv.innerHTML = `
            <input type="text" name="diaryImage[]" value="${url}" placeholder="å›¾ç‰‡é“¾æ¥"
                class="flex-1 p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
            <button type="button" class="remove-diary-image bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-800 text-red-600 dark:text-red-300 w-10 h-10 rounded-full flex items-center justify-center transition-smooth">
                <span class="text-xl font-bold">Ã—</span>
            </button>
        `;
        container.appendChild(inputDiv);

        // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨æ¥å®æ—¶æ›´æ–°å†…å®¹
        const inputField = inputDiv.querySelector('input');
        inputField.addEventListener('input', function() {
          const activeForm = document.querySelector('.form-content:not(.hidden)');
          if (activeForm) {
            const formType = activeForm.id.replace('Form', '');
            generateMarkdown(formType);
          }
        });

        // æ·»åŠ åˆ é™¤åŠŸèƒ½
        inputDiv.querySelector('.remove-diary-image').addEventListener('click', function() {
          const item = this.parentElement;
          item.classList.add('fade-out');
          setTimeout(() => {
            item.remove();
            // åˆ é™¤åæ›´æ–°ç”Ÿæˆçš„å†…å®¹
            const activeForm = document.querySelector('.form-content:not(.hidden)');
            if (activeForm) {
              const formType = activeForm.id.replace('Form', '');
              generateMarkdown(formType);
            }
          }, 300);
        });
      });

      // æ›´æ–°é¢„è§ˆ
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }

      showMessage(`æˆåŠŸè·å–åˆ° ${imageUrls.length} å¼ å›¾ç‰‡é“¾æ¥`, 'info');
    } catch (error) {
      console.error('è·å–R2å›¾ç‰‡é“¾æ¥å¤±è´¥:', error);
      showMessage(`è·å–R2å›¾ç‰‡é“¾æ¥å¤±è´¥: ${error.message}`, 'error');
    } finally {
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      this.innerHTML = originalText;
      this.disabled = false;
    }
  });

  // æ·»åŠ ç›¸å†Œå›¾ç‰‡åŠŸèƒ½
  document.getElementById('addPhotoBtn').addEventListener('click', function() {
    const container = document.getElementById('photosContainer');
    const inputDiv = document.createElement('div');
    inputDiv.className = 'album-image-input fade-in flex items-center gap-2 mb-2 image-input-container';
    inputDiv.innerHTML = `
        <input type="text" name="photoSrc[]" placeholder="å›¾ç‰‡é“¾æ¥"
            class="flex-1 p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]">
        <button type="button" class="remove-photo bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-800 text-red-600 dark:text-red-300 w-10 h-10 rounded-full flex items-center justify-center transition-smooth">
            <span class="text-xl font-bold">Ã—</span>
        </button>
    `;
    container.appendChild(inputDiv);

    // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨æ¥å®æ—¶æ›´æ–°å†…å®¹
    const inputField = inputDiv.querySelector('input');
    inputField.addEventListener('input', function() {
      const activeForm = document.querySelector('.form-content:not(.hidden)');
      if (activeForm) {
        const formType = activeForm.id.replace('Form', '');
        generateMarkdown(formType);
      }
    });

    // æ·»åŠ åˆ é™¤åŠŸèƒ½
    inputDiv.querySelector('.remove-photo').addEventListener('click', function() {
      const item = this.parentElement;
      item.classList.add('fade-out');
      setTimeout(() => {
        item.remove();
        // åˆ é™¤åæ›´æ–°ç”Ÿæˆçš„å†…å®¹
        const activeForm = document.querySelector('.form-content:not(.hidden)');
        if (activeForm) {
          const formType = activeForm.id.replace('Form', '');
          generateMarkdown(formType);
        }
      }, 300);
    });
  });

  // è·å–å½“å‰æ—¥æœŸå‡½æ•°
  function getCurrentDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // ä¸ºæ—¥æœŸè¾“å…¥æ¡†è®¾ç½®é»˜è®¤å€¼
  document.getElementById('normalPublished').value = getCurrentDate();
  document.getElementById('diaryDate').value = getCurrentDate();
  document.getElementById('albumDate').value = getCurrentDate();

  // ç”Ÿæˆå†…å®¹å‡½æ•°
  function generateMarkdown(type) {
    let title, date, description, tags = [], category, content;
    const extraFields = {};

    switch(type) {
      case 'normal': // å¸–å­
        title = document.getElementById('normalTitle').value;
        date = document.getElementById('normalPublished').value || getCurrentDate();
        description = document.getElementById('normalDescription').value;
        tags = document.getElementById('normalTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        category = document.getElementById('normalCategory').value;
        content = document.getElementById('normalContent').value;

        // å¤„ç†é¢å¤–å­—æ®µï¼Œç¡®ä¿publishedå­—æ®µå­˜åœ¨ä»¥é€šè¿‡æ„å»ºéªŒè¯
        extraFields.draft = document.getElementById('normalDraft')?.checked;
        extraFields.pinned = document.getElementById('normalPinned')?.checked;

        // å¦‚æœå‹¾é€‰äº†ä½¿ç”¨å°é¢å›¾ç‰‡ï¼Œåˆ™æ·»åŠ å›¾ç‰‡å­—æ®µ
        if (document.getElementById('normalUseImage')?.checked) {
          const imageValue = document.getElementById('normalImage').value;
          if (imageValue) {
            extraFields.image = imageValue;
          }
        }

        // å¤„ç†å¯†ç ä¿æŠ¤
        const usePassword = document.getElementById('normalUsePassword')?.checked;
        if (usePassword) {
          extraFields.encrypted = true;
          extraFields.password = document.getElementById('normalPassword')?.value || '666999';
        } else {
          extraFields.encrypted = false;
        }

        // å¤„ç†ä½œè€…ä¿¡æ¯
        const useAuthor = document.getElementById('normalUseAuthor')?.checked;
        if (useAuthor) {
          const authorValue = document.getElementById('normalAuthor')?.value;
          if (authorValue) {
            extraFields.author = authorValue;
          }
        }

        // å¤„ç†æ¥æºé“¾æ¥ - ä»…åœ¨ç”¨æˆ·è¾“å…¥æ—¶æ·»åŠ 
        const useSource = document.getElementById('normalUseSource')?.checked;
        if (useSource) {
          const sourceValue = document.getElementById('normalSource')?.value;
          if (sourceValue) {
            extraFields.sourceLink = sourceValue;
          }
        }

        // æ·»åŠ publishedå­—æ®µä»¥ç¡®ä¿æ„å»ºæˆåŠŸ
        extraFields.published = date;
        break;

      case 'diary': // æ—¥è®°
        title = document.getElementById('diaryTitle').value;
        date = document.getElementById('diaryDate').value || getCurrentDate();
        description = document.getElementById('diaryDescription')?.value || "";
        tags = (document.getElementById('diaryTags')?.value || "").split(',').map(tag => tag.trim()).filter(tag => tag);
        content = document.getElementById('diaryContent').value;

        // ä¸ºæ—¥è®°ç±»å‹æ·»åŠ æ—¥æœŸå­—æ®µ
        extraFields.date = date;

        // å¤„ç†å›¾ç‰‡
        const diaryImageType = document.querySelector('input[name="diaryImageType"]:checked')?.value || 'local';
        if(diaryImageType === 'r2' || (diaryImageType === 'local' && document.getElementById('diaryUseImage')?.checked)) {
          const imageInputs = document.querySelectorAll('#diaryImagesContainer input[name="diaryImage[]"]');
          extraFields.images = Array.from(imageInputs).map(input => input.value).filter(val => val);
        }
        break;

      case 'album': // ç›¸å†Œ
        title = document.getElementById('albumTitle').value;
        date = document.getElementById('albumDate').value || getCurrentDate();
        description = document.getElementById('albumDescription').value;
        const location = document.getElementById('albumLocation').value;
        tags = document.getElementById('albumTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        const hidden = document.getElementById('albumHidden').checked;
        const layout = document.getElementById('albumLayout').value || 'grid';
        const columns = parseInt(document.getElementById('albumColumns').value) || 3;
        const cover = document.getElementById('albumCover').value || '';

        // åˆ›å»ºå†…å®¹
        content = `# ${title}\n\n${description || 'è¿™æ˜¯ä¸€ä¸ªç›¸å†Œé¡µé¢'}`;

        // å¤„ç†ç›¸å†Œæ¨¡å¼
        const albumType = document.querySelector('input[name="albumType"]:checked').value;
        // R2ç›¸å†Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯å¤–éƒ¨é“¾æ¥ï¼Œå› ä¸ºå›¾ç‰‡æ˜¯ä»å¤–éƒ¨è·å–çš„
        const effectiveMode = albumType === 'r2' ? 'external' : albumType;
        const albumData = {
          title,
          date,
          description: description || "",
          location: location || "",
          tags: tags.length ? tags : [],
          hidden: hidden || false,
          layout: layout || "grid",
          columns: columns || 3,
          cover: cover,
          mode: effectiveMode,
          photos: []
        };

        // å¦‚æœæ˜¯å¤–éƒ¨æˆ–R2ç›¸å†Œï¼Œè·å–å›¾ç‰‡é“¾æ¥
        if (albumType === 'external' || albumType === 'r2') {
          const photoInputs = document.querySelectorAll('#photosContainer input[name="photoSrc[]"]');
          albumData.photos = Array.from(photoInputs).map(input => input.value).filter(val => val);
        }

        // ç”Ÿæˆç›¸å†Œçš„Markdownå†…å®¹
        let albumFrontmatter = `---
title: "${albumData.title}"
hidden: ${albumData.hidden}
description: "${albumData.description}"
date: "${albumData.date}"
location: "${albumData.location}"
tags: [${albumData.tags.map(tag => `"${tag}"`).join(', ')}]
layout: "${albumData.layout}"
columns: ${albumData.columns}`;

        // ä¸ºå¤–éƒ¨å’ŒR2ç›¸å†Œè®¾ç½®å°é¢å›¾ç‰‡
        if (albumType === 'external' || albumType === 'r2') {
          // å¦‚æœç”¨æˆ·æŒ‡å®šäº†å°é¢ï¼Œä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„å°é¢
          if (albumData.cover) {
            albumFrontmatter += `
cover: "${albumData.cover}"`;
          }
          // å¦‚æœæ²¡æœ‰æŒ‡å®šå°é¢ï¼Œä½†æœ‰å›¾ç‰‡ï¼Œä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºå°é¢
          else if (albumData.photos.length > 0) {
            albumFrontmatter += `
cover: "${albumData.photos[0]}"`;
          }
        } else {
          // æœ¬åœ°ç›¸å†Œï¼Œå¦‚æœæŒ‡å®šäº†å°é¢ï¼Œæ·»åŠ å°é¢å­—æ®µ
          if (albumData.cover) {
            albumFrontmatter += `
cover: "${albumData.cover}"`;
          }
        }

        // æ·»åŠ æ¨¡å¼å’Œå›¾ç‰‡æ•°ç»„
        albumFrontmatter += `
mode: "${albumData.mode}"`;

        // å¦‚æœæ˜¯å¤–éƒ¨æˆ–R2ç›¸å†Œä¸”æœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡æ•°ç»„
        if ((albumType === 'external' || albumType === 'r2') && albumData.photos.length > 0) {
          albumFrontmatter += `
photos: [`;
          albumFrontmatter += `\n` + albumData.photos.map(photo => `  { src: "${photo}" }`).join(',\n');
          albumFrontmatter += `\n]`;
        }

        albumFrontmatter += `
---\n\n${content}`;

        // è®¾ç½®æ–‡ä»¶å - ä½¿ç”¨æ—¥æœŸ-æ ‡é¢˜æ ¼å¼ï¼Œä¸å¸–å­å’Œæ—¥è®°ä¸€è‡´
        const slug = title.toLowerCase()
                         .replace(/[^\w\s\u4e00-\u9fff]/g, '')  // å…è®¸å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼å’Œä¸­æ–‡å­—ç¬¦
                         .replace(/\s+/g, '-');                // ç©ºæ ¼æ›¿æ¢ä¸ºçŸ­æ¨ªçº¿

        document.getElementById('fileName').value = slug ? `${date}-${slug}.md` : `${date}-untitled.md`;
        document.getElementById('fileDirectory').value = 'src/content/albums';

        document.getElementById('markdownResult').textContent = albumFrontmatter;
        return; // æå‰è¿”å›ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»è®¾ç½®äº†ç»“æœ
    }

    // æ„å»ºFrontmatterï¼ŒåªåŒ…å«publishedå­—æ®µï¼ˆå®Œå…¨æŒ‰ç…§æ‚¨çš„è¦æ±‚ï¼‰
    let frontmatter = `---
title: "${title}"`;

    // å¯¹äºå¸–å­ç±»å‹ï¼ŒåªåŒ…å«publishedå­—æ®µï¼ˆå®Œå…¨æŒ‰ç…§æ‚¨çš„è¦æ±‚ï¼‰
    if (type === 'normal') {
      frontmatter += `
published: ${date}`;
    }
    // ç›¸å†Œå’Œæ—¥è®°ç±»å‹ä¸éœ€è¦publishedå­—æ®µ

    if(description) frontmatter += `
description: "${description}"`;
    if(category) frontmatter += `
category: "${category}"`;
    if(tags.length > 0) frontmatter += `
tags: [${tags.map(tag => `"${tag}"`).join(', ')}]`;

    // æ·»åŠ é¢å¤–å­—æ®µï¼ˆé¿å…é‡å¤æ·»åŠ å·²æœ‰çš„å­—æ®µï¼‰
    Object.entries(extraFields).forEach(([key, value]) => {
      if(value !== undefined) {
        // è·³è¿‡å·²æ˜¾å¼æ·»åŠ çš„å­—æ®µï¼Œé¿å…é‡å¤
        if (type === 'normal' && key === 'published') {
          return; // publishedå­—æ®µå·²æ·»åŠ ï¼Œè·³è¿‡
        }

        if(typeof value === 'string') {
          frontmatter += `
${key}: "${value}"`;
        } else if(typeof value === 'boolean' || typeof value === 'number') {
          frontmatter += `
${key}: ${value}`;
        } else if(Array.isArray(value)) {
          frontmatter += `
${key}: [${value.map(v => `"${v}"`).join(', ')}]`;
        } else if(typeof value === 'object') {
          frontmatter += `
${key}: ${JSON.stringify(value, null, 2).split('\n').join('\n  ')}`;
        }
      }
    });

    frontmatter += `
---
`;

    // æœ€ç»ˆå†…å®¹ = Frontmatter + å†…å®¹
    const fullContent = frontmatter + content;

    // è®¾ç½®æ–‡ä»¶å - ä½¿ç”¨æ—¥æœŸ-æ ‡é¢˜æ ¼å¼ï¼Œæ”¯æŒä¸­æ–‡å­—ç¬¦
    const slug = title.toLowerCase()
                     .replace(/[^\w\s\u4e00-\u9fff]/g, '')  // å…è®¸å­—æ¯ã€æ•°å­—ã€ç©ºæ ¼å’Œä¸­æ–‡å­—ç¬¦
                     .replace(/\s+/g, '-');                // ç©ºæ ¼æ›¿æ¢ä¸ºçŸ­æ¨ªçº¿

    document.getElementById('fileName').value = slug ? `${date}-${slug}.md` : `${date}-untitled.md`;

    document.getElementById('fileDirectory').value =
      type === 'normal' ? 'src/content/posts' :
      type === 'diary' ? 'src/content/diary' : 'src/content/albums';

    // æ˜¾ç¤ºåœ¨ç»“æœåŒºåŸŸ
    document.getElementById('markdownResult').textContent = fullContent;
  }

  // ä¸ºæäº¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨

  // ä¸ºæ‰€æœ‰è¾“å…¥å­—æ®µæ·»åŠ å®æ—¶é¢„è§ˆåŠŸèƒ½
  const inputs = document.querySelectorAll('input, textarea, select');
  inputs.forEach(input => {
    if (input.type !== 'checkbox' && input.type !== 'radio') {
      input.addEventListener('input', function() {
        // è·å–å½“å‰æ´»åŠ¨çš„è¡¨å•
        const activeForm = document.querySelector('.form-content:not(.hidden)');
        if (activeForm) {
          const formType = activeForm.id.replace('Form', '');
          generateMarkdown(formType);
        }
      });
    }
  });

  // å¤åˆ¶åŠŸèƒ½
  document.getElementById('copyButton').addEventListener('click', function() {
    const code = document.getElementById('markdownResult').textContent;
    navigator.clipboard.writeText(code).then(() => {
      const originalText = this.innerHTML;
      this.innerHTML = '<i class="fa fa-check mr-1" aria-hidden="true"></i>å·²å¤åˆ¶';
      setTimeout(() => {
        this.innerHTML = originalText;
      }, 2000);
    });
  });

  // è®¤è¯æŒ‰é’®äº‹ä»¶
  document.getElementById('create-auth-btn').addEventListener('click', function() {
    if (githubToken) {
      // å¦‚æœå·²è®¤è¯ï¼Œæ¸…é™¤ä»¤ç‰Œ
      localStorage.removeItem('github_access_token');
      githubToken = null;
    } else {
      // å¦‚æœæœªè®¤è¯ï¼Œæ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('create-auth-modal').classList.remove('hidden');
      // è§¦å‘é‡ç»˜ä»¥å¯ç”¨è¿‡æ¸¡
      void document.getElementById('create-auth-modal').offsetWidth;
      document.getElementById('create-auth-modal').classList.remove('bg-opacity-0');
      document.getElementById('create-auth-modal').classList.add('bg-opacity-50');

      const modalContent = document.getElementById('create-auth-modal').querySelector('div:last-child');
      void modalContent.offsetWidth; // è§¦å‘é‡ç»˜
      modalContent.classList.remove('opacity-0', 'scale-95');
      modalContent.classList.add('opacity-100', 'scale-100');

      document.getElementById('create-token-input').focus();
    }
    updateCreateAuthStatus();
  });

  // ç¡®è®¤æŒ‰é’®äº‹ä»¶
  document.getElementById('confirm-create-auth-btn').addEventListener('click', function() {
    const token = document.getElementById('create-token-input').value.trim();
    if (token) {
      localStorage.setItem('github_access_token', token);
      githubToken = token;
      updateCreateAuthStatus();
      // æ¸…ç©ºè¾“å…¥æ¡†å¹¶éšè—æ¨¡æ€æ¡†
      document.getElementById('create-token-input').value = '';
      hideCreateAuthModal();
    } else {
      showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„Personal Access Token', 'error');
    }
  });

  // å–æ¶ˆæŒ‰é’®äº‹ä»¶
  document.getElementById('cancel-create-auth-btn').addEventListener('click', function() {
    // æ¸…ç©ºè¾“å…¥æ¡†å¹¶éšè—æ¨¡æ€æ¡†
    document.getElementById('create-token-input').value = '';
    hideCreateAuthModal();
  });

  // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨åŒºåŸŸå…³é—­
  document.getElementById('create-auth-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      // æ¸…ç©ºè¾“å…¥æ¡†å¹¶éšè—æ¨¡æ€æ¡†
      document.getElementById('create-token-input').value = '';
      hideCreateAuthModal();
    }
  });

  // æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('create-auth-modal').classList.contains('hidden')) {
      // æ¸…ç©ºè¾“å…¥æ¡†å¹¶éšè—æ¨¡æ€æ¡†
      document.getElementById('create-token-input').value = '';
      hideCreateAuthModal();
    }
  });

  // éšè—è®¤è¯æ¨¡æ€æ¡†çš„å‡½æ•°
  function hideCreateAuthModal() {
    const modal = document.getElementById('create-auth-modal');
    const modalContent = modal.querySelector('div:last-child');
    
    // æ·»åŠ å…³é—­åŠ¨ç”»
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    
    modal.classList.remove('bg-opacity-50');
    modal.classList.add('bg-opacity-0');
    
    // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†éšè—å…ƒç´ 
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 200); // ä¸è¿‡æ¸¡æ—¶é—´åŒ¹é…
  }

  // æäº¤åˆ°GitHubåŠŸèƒ½
  document.getElementById('saveToGithub').addEventListener('click', async function() {
    const content = document.getElementById('markdownResult').textContent;
    const fileName = document.getElementById('fileName').value;
    const directory = document.getElementById('fileDirectory').value;

    if (!content || !fileName) {
      showMessage('è¯·å…ˆç”Ÿæˆå†…å®¹å¹¶å¡«å†™æ–‡ä»¶å', 'error');
      return;
    }

    if (!githubToken) {
      showMessage('è¯·å…ˆè¿›è¡ŒGitHubè®¤è¯', 'error');
      return;
    }

    try {
      // è¯»å–å½“å‰æ–‡ä»¶ä»¥è·å–SHAï¼ˆå¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼‰
      let sha = null;
      try {
        const response = await fetch(`https://api.github.com/repos/Doulor/Blog/contents/${directory}/${fileName}`, {
          headers: {
            'Authorization': `Bearer ${githubToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          sha = data.sha;
        }
      } catch (e) {
        console.log('æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
      }

      // æ­£ç¡®ç¼–ç å†…å®¹ï¼Œæ”¯æŒUTF-8ç¼–ç 
      const uint8Array = new TextEncoder().encode(content);
      let binary = '';
      for (let i = 0; i < uint8Array.length; i++) {
        binary += String.fromCharCode(uint8Array[i]);
      }
      const base64Content = btoa(binary);

      // å‡†å¤‡æäº¤æ•°æ®
      const commitData = {
        message: `æ·»åŠ /æ›´æ–° ${directory}/${fileName} [é€šè¿‡å†…å®¹åˆ›å»ºå™¨]`,
        content: base64Content,
        branch: 'main'
      };

      if (sha) {
        commitData.sha = sha; // å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œéœ€è¦æä¾›SHA
      }

      // æäº¤æ–‡ä»¶
      const result = await fetch(`https://api.github.com/repos/Doulor/Blog/contents/${directory}/${fileName}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${githubToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(commitData)
      });

      const resultData = await result.json();

      if (result.ok) {
        // æ˜¾ç¤ºæäº¤æˆåŠŸå¼¹çª—
        showSubmitModal();
      } else {
        console.error('æäº¤å¤±è´¥:', resultData);
        if (resultData.message && resultData.message.includes('Bad credentials')) {
          localStorage.removeItem('github_access_token'); // ç§»é™¤æ— æ•ˆä»¤ç‰Œ
          githubToken = null;
          updateCreateAuthStatus();
          showMessage('è®¤è¯ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
        } else {
          showMessage('æäº¤å¤±è´¥: ' + (resultData.message || JSON.stringify(resultData)), 'error');
        }
      }
    } catch (error) {
      console.error('æäº¤é”™è¯¯:', error);
      if (error.message.includes('fetch') || error.message.includes('network')) {
        showMessage('ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•', 'error');
      } else {
        showMessage('æäº¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
      }
    }
  });

  // æ˜¾ç¤ºæäº¤æˆåŠŸå¼¹çª—
  function showSubmitModal() {
    const modal = document.getElementById('submitModal');

    // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ·»åŠ èƒŒæ™¯å˜æš—æ•ˆæœ
    modal.classList.remove('hidden');
    // è§¦å‘é‡ç»˜ä»¥å¯ç”¨è¿‡æ¸¡
    void modal.offsetWidth;
    modal.classList.remove('bg-opacity-0');
    modal.classList.add('bg-opacity-50');

    const modalContent = modal.querySelector('div:last-child');
    void modalContent.offsetWidth; // è§¦å‘é‡ç»˜
    modalContent.classList.remove('opacity-0', 'scale-95');
    modalContent.classList.add('opacity-100', 'scale-100');
  }

  // éšè—æäº¤æˆåŠŸå¼¹çª—
  function hideSubmitModal() {
    const modal = document.getElementById('submitModal');
    const modalContent = modal.querySelector('div:last-child');

    // æ·»åŠ å…³é—­åŠ¨ç”»
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');

    modal.classList.remove('bg-opacity-50');
    modal.classList.add('bg-opacity-0');

    // ç­‰å¾…åŠ¨ç”»å®Œæˆåå†éšè—å…ƒç´ 
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 200); // ä¸è¿‡æ¸¡æ—¶é—´åŒ¹é…
  }

  // å…³é—­æ¨¡æ€æ¡†æŒ‰é’®äº‹ä»¶
  document.getElementById('closeModalBtn').addEventListener('click', function() {
    hideSubmitModal();
  });

  // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨åŒºåŸŸå…³é—­
  document.getElementById('submitModal').addEventListener('click', function(e) {
    if (e.target === this) {
      hideSubmitModal();
    }
  });

  // æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('submitModal').classList.contains('hidden')) {
      hideSubmitModal();
    }
  });

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  updateCreateAuthStatus();


  // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªè¡¨å•
  document.querySelectorAll('.form-content').forEach((form, index) => {
    if (index === 0) {
      form.classList.remove('hidden');
    } else {
      form.classList.add('hidden');
    }
  });

  generateMarkdown('normal');
</script>

<style>
  .fade-in {
    animation: fadeIn 0.3s ease-in-out;
  }
  .fade-out {
    animation: fadeOut 0.3s ease-in-out;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @keyframes fadeOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(10px);
    }
  }
  .tab-active {
    color: var(--primary);
    font-weight: 600;
  }

  /* å¤é€‰æ¡†ä¼˜åŒ–æ ·å¼ */
  input[type="checkbox"] {
    transition: all 0.2s ease;
  }

  /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
  .btn-card {
    transition: all 0.2s ease;
  }

  /* è¡¨å•æ§ä»¶èšç„¦æ•ˆæœ */
  input[type="text"],
  input[type="date"],
  textarea,
  select {
    transition: all 0.2s ease;
  }

  input[type="text"]:focus,
  input[type="date"]:focus,
  textarea:focus,
  select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
  }

  /* æ ‡ç­¾æ‚¬åœæ•ˆæœ */
  label {
    transition: all 0.2s ease;
  }

  label:hover {
    color: var(--primary);
  }

  /* æŒ‰é’®æ ·å¼ */
  .btn-card {
    transition: all 0.2s ease;
  }

  /* ç¡®ä¿æŒ‰é’®æ–‡å­—åœ¨æš—è‰²èƒŒæ™¯ä¸‹å¯è§ */
  .btn-card.text-white {
    color: white;
  }

  /* For dark mode, ensure good contrast */
  @media (prefers-color-scheme: dark) {
    #normalSubmitButton {
      color: #ffffff !important;
    }
  }

  /* å›¾ç‰‡è¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
  .image-input-container {
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
    background-color: #ffffff;
    transition: all 0.2s ease;
  }

  .dark .image-input-container {
    border-color: #374151;
    background-color: #1f2937;
  }

  .image-input-container:hover {
    border-color: var(--primary);
  }

  .dark .image-input-container:hover {
    border-color: var(--primary);
  }
</style>