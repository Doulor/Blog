---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { getCollection } from 'astro:content';
import { scanAlbums } from "@utils/album-scanner";

const posts = await getCollection('posts');
const diary = await getCollection('diary');
const albumsData = await scanAlbums();

// 按日期排序
const sortedPosts = posts.sort((a, b) => new Date(b.data.published || b.data.date).getTime() - new Date(a.data.published || a.data.date).getTime());
const sortedDiary = diary.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
const sortedAlbums = albumsData.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
---

<MainGridLayout title="内容管理器" description="管理博客文章、日记和相册">
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div id="content-manager-root" class="card-base z-10 px-6 md:px-9 pt-6 pb-4 relative w-full">
      <!-- 页面标题 -->
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 mb-3">
          内容管理器
        </h1>
        <p class="text-neutral-600 dark:text-neutral-400">
          管理博客文章、日记和相册
        </p>
      </header>

      <!-- 认证状态 -->
      <div class="mb-8 p-4 rounded-xl bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/30 dark:to-blue-900/30 border border-green-200 dark:border-green-800">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-medium text-lg">GitHub认证状态</h3>
            <p id="auth-status" class="text-sm text-gray-600 dark:text-gray-400 flex items-center">
              <span id="auth-status-indicator" class="w-3 h-3 rounded-full bg-red-500 mr-2"></span>
              <span id="auth-status-text">未认证</span>
            </p>
          </div>
          <div class="flex space-x-2">
            <button type="button" class="btn-card h-12 px-4 rounded-lg" title="刷新认证状态" onclick="location.reload();">
              <i class="fa fa-refresh mr-1" aria-hidden="true"></i>刷新
            </button>
            <button id="auth-btn" class="btn-card h-12 px-4 rounded-lg">
              <span id="auth-btn-text">登录</span>
            </button>
          </div>
        </div>

        <!-- GitHub Token 输入模态框 -->
        <div id="auth-modal" class="absolute inset-0 bg-black bg-opacity-0 flex items-start justify-center z-50 hidden transition-opacity ease-out duration-500">
          <div class="bg-white dark:bg-neutral-800 rounded-xl p-6 w-full max-w-md shadow-2xl mt-16 opacity-0 transition-all ease-out duration-500 scale-95">
            <h3 class="text-lg font-semibold mb-4 text-neutral-900 dark:text-neutral-100">GitHub Personal Access Token</h3>
            <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-4">
              请输入您的GitHub Personal Access Token。该Token仅在本地存储，用于访问您的仓库。
            </p>
            <div class="mb-4">
              <input
                type="password"
                id="token-input"
                placeholder="输入您的Personal Access Token"
                class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-700 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
              >
            </div>
            <div class="flex justify-end space-x-3">
              <button id="cancel-auth-btn" class="btn-card h-10 px-4 rounded-lg !bg-gray-500 hover:!bg-gray-600 text-white">
                取消
              </button>
              <button id="confirm-auth-btn" class="btn-card h-10 px-4 rounded-lg !bg-green-600 hover:!bg-green-700 text-white">
                确认
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 加载状态 -->
      <div id="loading-indicator" class="hidden flex justify-center items-center mb-6">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--primary)]"></div>
        <span class="ml-3 text-neutral-600 dark:text-neutral-400">加载中...</span>
      </div>

      <!-- 提示信息 -->
      <div id="message-area" class="mb-6 hidden">
        <div id="info-message" class="p-4 rounded-lg bg-blue-50 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200 border border-blue-200 dark:border-blue-800"></div>
        <div id="error-message" class="p-4 rounded-lg bg-red-50 text-red-800 dark:bg-red-900/30 dark:text-red-200 border border-red-200 dark:border-red-800 mt-2 hidden"></div>
      </div>

      <!-- 删除确认弹窗 -->
      <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300">
        <div class="bg-white dark:bg-neutral-800 rounded-xl p-6 w-full max-w-md shadow-2xl mx-4 transform scale-95 transition-all duration-300 opacity-0">
          <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
              <i class="fa fa-exclamation-triangle text-red-600 dark:text-red-400 text-2xl" aria-hidden="true"></i>
            </div>
            <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-100 mb-2">确认删除</h3>
            <p class="text-neutral-600 dark:text-neutral-400 mb-2">您确定要删除 "<span id="deleteTitle" class="font-medium"></span>" 吗？</p>
            <p class="text-neutral-600 dark:text-neutral-400 mb-6">此操作无法撤销。</p>
            <div class="flex justify-end space-x-3">
              <button id="cancelDeleteBtn" class="btn-card h-12 px-6 rounded-lg bg-gray-500 hover:bg-gray-600 text-white">
                取消
              </button>
              <button id="confirmDeleteBtn" class="btn-card h-12 px-6 rounded-lg bg-red-600 hover:bg-red-700 text-white">
                确定删除
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 选项卡 -->
      <div class="flex border-b border-neutral-200 dark:border-neutral-700 mb-6">
        <button id="posts-tab" class="tab-btn px-4 py-2 font-medium text-neutral-600 dark:text-neutral-400 border-b-2 border-transparent hover:text-[var(--primary)] hover:border-[var(--primary)]" data-target="posts-content">
          文章管理
        </button>
        <button id="diary-tab" class="tab-btn px-4 py-2 font-medium text-neutral-600 dark:text-neutral-400 border-b-2 border-transparent hover:text-[var(--primary)] hover:border-[var(--primary)]" data-target="diary-content">
          日记管理
        </button>
        <button id="albums-tab" class="tab-btn px-4 py-2 font-medium text-neutral-600 dark:text-neutral-400 border-b-2 border-transparent hover:text-[var(--primary)] hover:border-[var(--primary)]" data-target="albums-content">
          相册管理
        </button>
      </div>

      <!-- 搜索框 -->
      <div class="mb-6">
        <input
          type="text"
          id="search-input"
          placeholder="搜索内容..."
          class="w-full p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-[var(--primary)]"
        />
      </div>

      <!-- 文章列表 -->
      <div id="posts-content" class="content-section">
        <h2 class="text-xl font-semibold mb-4">文章列表</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="posts-grid">
          {sortedPosts.map(post => (
            <article class="group bg-white dark:bg-neutral-800 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 border border-neutral-200 dark:border-neutral-700 relative">
              <div class="p-5">
                <div class="flex justify-between items-start mb-3">
                  <h3 class="font-bold text-lg text-neutral-900 dark:text-neutral-100 group-hover:text-[var(--primary)] transition-colors">
                    {post.data.title}
                  </h3>
                  <div class="flex space-x-2">
                    <button
                      class="edit-btn text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                      data-type="post"
                      data-slug={post.id.replace('posts/', '').replace('.md', '')}
                      data-title={post.data.title}
                    >
                      编辑
                    </button>
                    <button
                      class="delete-btn text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                      data-type="post"
                      data-slug={post.id.replace('posts/', '').replace('.md', '')}
                      data-title={post.data.title}
                    >
                      删除
                    </button>
                  </div>
                </div>
                
                {post.data.description && (
                  <p class="text-neutral-600 dark:text-neutral-400 text-sm mb-3 line-clamp-2">
                    {post.data.description}
                  </p>
                )}
                
                <div class="flex items-center justify-between text-xs text-neutral-500 dark:text-neutral-500">
                  <div class="flex items-center gap-4">
                    {post.data.category && (
                      <span class="btn-regular h-6 text-xs px-2 rounded-lg">
                        {post.data.category}
                      </span>
                    )}
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-1">
                        {post.data.tags.slice(0, 2).map(tag => (
                          <span class="btn-regular h-6 text-xs px-2 rounded-lg" key={tag}>
                            {tag}
                          </span>
                        ))}
                        {post.data.tags.length > 2 && (
                          <span class="btn-regular h-6 text-xs px-2 rounded-lg">
                            +{post.data.tags.length - 2}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                  <time>{new Date(post.data.published || post.data.date).toLocaleDateString('zh-CN')}</time>
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>

      <!-- 日记列表 -->
      <div id="diary-content" class="content-section hidden">
        <h2 class="text-xl font-semibold mb-4">日记列表</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="diary-grid">
          {sortedDiary.map(d => (
            <article class="group bg-white dark:bg-neutral-800 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 border border-neutral-200 dark:border-neutral-700 relative">
              <div class="p-5">
                <div class="flex justify-between items-start mb-3">
                  <h3 class="font-bold text-lg text-neutral-900 dark:text-neutral-100 group-hover:text-[var(--primary)] transition-colors">
                    {d.data.title || '日记条目'}
                  </h3>
                  <div class="flex space-x-2">
                    <button
                      class="edit-btn text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                      data-type="diary"
                      data-slug={d.id.replace('diary/', '').replace('.md', '')}
                      data-title={d.data.title || '日记条目'}
                    >
                      编辑
                    </button>
                    <button
                      class="delete-btn text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                      data-type="diary"
                      data-slug={d.id.replace('diary/', '').replace('.md', '')}
                      data-title={d.data.title || '日记条目'}
                    >
                      删除
                    </button>
                  </div>
                </div>
                
                {d.data.description && (
                  <p class="text-neutral-600 dark:text-neutral-400 text-sm mb-3 line-clamp-2">
                    {d.data.description}
                  </p>
                )}
                
                <div class="flex items-center justify-between text-xs text-neutral-500 dark:text-neutral-500">
                  <div class="flex flex-wrap gap-1">
                    {d.data.tags && d.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-1">
                        {d.data.tags.slice(0, 2).map(tag => (
                          <span class="btn-regular h-6 text-xs px-2 rounded-lg" key={tag}>
                            {tag}
                          </span>
                        ))}
                        {d.data.tags.length > 2 && (
                          <span class="btn-regular h-6 text-xs px-2 rounded-lg">
                            +{d.data.tags.length - 2}
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                  <time>{new Date(d.data.date).toLocaleDateString('zh-CN')}</time>
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>

      <!-- 相册列表 -->
      <div id="albums-content" class="content-section hidden">
        <h2 class="text-xl font-semibold mb-4">相册列表</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="albums-grid">
          {sortedAlbums.map(album => (
            <article class="group bg-white dark:bg-neutral-800 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 border border-neutral-200 dark:border-neutral-700">
              <div class="aspect-[4/3] overflow-hidden bg-neutral-100 dark:bg-neutral-700">
                <img
                  src={album.cover || "/images/album-placeholder.jpg"}
                  alt={album.title}
                  class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                  loading="lazy"
                />
              </div>
              <div class="p-4">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-bold text-lg text-neutral-900 dark:text-neutral-100 group-hover:text-[var(--primary)] transition-colors">
                    {album.title}
                  </h3>
                  <div class="flex space-x-2">
                    <button
                      class="edit-btn text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                      data-type="album"
                      data-slug={album.id}
                      data-title={album.title}
                    >
                      编辑
                    </button>
                    <button
                      class="delete-btn text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                      data-type="album"
                      data-slug={album.id}
                      data-title={album.title}
                    >
                      删除
                    </button>
                  </div>
                </div>

                {album.description && (
                  <p class="text-neutral-600 dark:text-neutral-400 text-sm mb-2 line-clamp-2">
                    {album.description}
                  </p>
                )}

                <div class="flex items-center justify-between text-xs text-neutral-500 dark:text-neutral-500">
                  <div class="flex items-center gap-4">
                    <span>{album.photos?.length || 0} 张照片</span>
                    {album.location && (
                      <span class="flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                        </svg>
                        {album.location}
                      </span>
                    )}
                  </div>
                  <time>{new Date(album.date).toLocaleDateString('zh-CN')}</time>
                </div>

                {album.tags && album.tags.length > 0 && (
                  <div class="flex flex-wrap gap-1 mt-2">
                    {album.tags.slice(0, 3).map(tag => (
                      <span class="btn-regular h-6 text-xs px-2 rounded-lg" key={tag}>
                        {tag}
                      </span>
                    ))}
                    {album.tags.length > 3 && (
                      <span class="btn-regular h-6 text-xs px-2 rounded-lg">
                        +{album.tags.length - 3}
                      </span>
                    )}
                  </div>
                )}
              </div>
            </article>
          ))}
        </div>
      </div>
    </div>
  </div>
</MainGridLayout>

<script>
  function setupContentManager() {
    const rootEl = document.getElementById('content-manager-root');
    if (!rootEl || rootEl.dataset.cmInit === 'true') return;
    rootEl.dataset.cmInit = 'true';

    // 管理认证状态 - 使用函数获取最新token
    function getGithubToken() {
      return localStorage.getItem('github_access_token') || null;
    }

  // 更新认证状态显示
  function updateAuthStatus() {
    const githubToken = getGithubToken();
    const authStatusText = document.getElementById('auth-status-text');
    const authStatusIndicator = document.getElementById('auth-status-indicator');
    const authBtnText = document.getElementById('auth-btn-text');

    if (githubToken) {
      authStatusText.textContent = '已认证';
      authStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
      authBtnText.textContent = '退出';
    } else {
      authStatusText.textContent = '未认证';
      authStatusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
      authBtnText.textContent = '登录';
    }
  }

  // 显示消息
  function showMessage(message, type = 'info') {
    const messageArea = document.getElementById('message-area');
    const infoMessage = document.getElementById('info-message');
    const errorMessage = document.getElementById('error-message');

    messageArea.classList.remove('hidden');

    if (type === 'info') {
      infoMessage.textContent = message;
      infoMessage.classList.remove('hidden');
      errorMessage.classList.add('hidden');
    } else if (type === 'error') {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
      infoMessage.classList.add('hidden');
    }

    // 3秒后自动隐藏
    setTimeout(() => {
      messageArea.classList.add('hidden');
    }, 3000);
  }

  // 显示加载指示器
  function showLoading(show = true) {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (show) {
      loadingIndicator.classList.remove('hidden');
    } else {
      loadingIndicator.classList.add('hidden');
    }
  }

  // 选项卡切换功能
  document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', function() {
      // 移除所有活动状态
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.add('text-neutral-600', 'dark:text-neutral-400', 'border-transparent');
        btn.classList.remove('text-[var(--primary)]', 'border-[var(--primary)]');
      });

      // 添加活动状态到当前按钮
      this.classList.add('text-[var(--primary)]', 'border-[var(--primary)]');
      this.classList.remove('text-neutral-600', 'dark:text-neutral-400', 'border-transparent');

      // 隐藏所有内容区域
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('hidden');
      });

      // 显示目标区域
      const target = this.getAttribute('data-target');
      document.getElementById(target).classList.remove('hidden');
    });
  });

  // 认证按钮事件
  document.getElementById('auth-btn').addEventListener('click', function() {
    const currentToken = getGithubToken();
    if (currentToken) {
      // 如果已认证，清除令牌
      localStorage.removeItem('github_access_token');
    } else {
      // 如果未认证，显示模态框
      const modal = document.getElementById('auth-modal');
      modal.classList.remove('hidden');
      // 确保在下一个动画帧中触发过渡
      requestAnimationFrame(() => {
        modal.classList.remove('bg-opacity-0');
        modal.classList.add('bg-opacity-50');

        const modalContent = modal.querySelector('div:last-child');
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
      });

      document.getElementById('token-input').focus();
    }
    updateAuthStatus();
  });

  // 确认按钮事件
  document.getElementById('confirm-auth-btn').addEventListener('click', function() {
    const token = document.getElementById('token-input').value.trim();
    if (token) {
      localStorage.setItem('github_access_token', token);
      updateAuthStatus();
      // 清空输入框并隐藏模态框
      document.getElementById('token-input').value = '';
      hideAuthModal();
    } else {
      showMessage('请输入有效的Personal Access Token', 'error');
    }
  });

  // 取消按钮事件
  document.getElementById('cancel-auth-btn').addEventListener('click', function() {
    // 清空输入框并隐藏模态框
    document.getElementById('token-input').value = '';
    hideAuthModal();
  });

  // 点击模态框外部关闭
  document.getElementById('auth-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      // 清空输入框并隐藏模态框
      document.getElementById('token-input').value = '';
      hideAuthModal();
    }
  });

  // 按ESC键关闭模态框
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('auth-modal').classList.contains('hidden')) {
      // 清空输入框并隐藏模态框
      document.getElementById('token-input').value = '';
      hideAuthModal();
    }
  });

  // 隐藏认证模态框的函数
  function hideAuthModal() {
    const modal = document.getElementById('auth-modal');
    const modalContent = modal.querySelector('div:last-child');

    // 添加关闭动画
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');

    modal.classList.remove('bg-opacity-50');
    modal.classList.add('bg-opacity-0');

    // 等待动画完成后再隐藏元素
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 500); // 与过渡时间匹配
  }

  // 编辑功能
  document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', async function() {
      const githubToken = getGithubToken();
      if (!githubToken) {
        showMessage('请先进行GitHub认证');
        return;
      }

      const type = this.getAttribute('data-type');
      const slug = this.getAttribute('data-slug');

      try {
        showLoading(true);

        // 使用GitHub API获取文件信息和内容
        const response = await fetch(`https://api.github.com/repos/Doulor/Blog/contents/src/content/${type === 'post' ? 'posts' : type === 'diary' ? 'diary' : 'albums'}/${slug}.md`, {
          headers: {
            'Authorization': 'Bearer ' + githubToken
          }
        });

        if (!response.ok) {
          throw new Error(`获取文件信息失败: ${response.status}`);
        }

        const data = await response.json();

        // 正确解码Base64内容，支持UTF-8编码
        const binaryString = atob(data.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        const decodedContent = new TextDecoder('utf-8').decode(bytes);

        // 存储编辑信息到本地存储
        localStorage.setItem('editContent', decodedContent);
        localStorage.setItem('editingType', type);
        localStorage.setItem('editingSlug', slug);
        localStorage.setItem('editingFilePath', `src/content/${type === 'post' ? 'posts' : type === 'diary' ? 'diary' : 'albums'}/${slug}.md`);

        // 跳转到统一编辑界面
        window.location.href = '/my-editor/';
      } catch (error) {
        console.error('获取内容失败:', error);
        showMessage('获取内容失败: ' + error.message, 'error');
      } finally {
        showLoading(false);
      }
    });
  });

  // 删除功能
  document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', function() {
      const githubToken = getGithubToken();
      if (!githubToken) {
        showMessage('请先进行GitHub认证');
        return;
      }

      const type = this.getAttribute('data-type');
      const slug = this.getAttribute('data-slug');
      const title = this.getAttribute('data-title');

      // 设置要删除的项目信息
      document.getElementById('deleteTitle').textContent = title;
      document.getElementById('confirmDeleteBtn').setAttribute('data-type', type);
      document.getElementById('confirmDeleteBtn').setAttribute('data-slug', slug);

      // 显示删除确认弹窗
      showDeleteModal();
    });
  });

  // 显示删除确认弹窗
  function showDeleteModal() {
    const modal = document.getElementById('deleteModal');

    // 显示模态框并添加背景变暗效果
    modal.classList.remove('hidden');
    // 触发重绘以启用过渡
    void modal.offsetWidth;
    modal.classList.remove('opacity-0');
    modal.classList.add('opacity-100');

    const modalContent = modal.querySelector('div:last-child');
    void modalContent.offsetWidth; // 触发重绘
    modalContent.classList.remove('opacity-0', 'scale-95');
    modalContent.classList.add('opacity-100', 'scale-100');
  }

  // 隐藏删除确认弹窗
  function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const modalContent = modal.querySelector('div:last-child');

    // 添加关闭动画
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');

    modal.classList.remove('opacity-100');
    modal.classList.add('opacity-0');

    // 等待动画完成后再隐藏元素
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300); // 与过渡时间匹配
  }

  // 确认删除按钮事件
  document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    const type = this.getAttribute('data-type');
    const slug = this.getAttribute('data-slug');

    performDelete(type, slug);
    hideDeleteModal();
  });

  // 取消删除按钮事件
  document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
    hideDeleteModal();
  });

  // 点击模态框外部区域关闭
  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      hideDeleteModal();
    }
  });

  // 按ESC键关闭模态框
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('deleteModal').classList.contains('hidden')) {
      hideDeleteModal();
    }
  });

  // 执行删除操作
  async function performDelete(type, slug) {
    const githubToken = getGithubToken();
    if (!githubToken) {
      showMessage('请先进行GitHub认证', 'error');
      return;
    }

    try {
      // 构建文件路径
      let filePath;
      switch(type) {
        case 'post':
          filePath = 'src/content/posts/' + slug + '.md';
          break;
        case 'diary':
          filePath = 'src/content/diary/' + slug + '.md';
          break;
        case 'album':
          filePath = 'src/content/albums/' + slug + '.md';
          break;
        default:
          alert('未知内容类型');
          return;
      }

      // 获取当前文件的SHA
      const getFileResponse = await fetch('https://api.github.com/repos/Doulor/Blog/contents/' + filePath, {
        headers: {
          'Authorization': 'Bearer ' + githubToken
        }
      });

      if (!getFileResponse.ok) {
        if (getFileResponse.status === 401 || getFileResponse.status === 403) {
          throw new Error('GitHub认证令牌无效或权限不足');
        }
        throw new Error('获取文件信息失败');
      }

      const fileData = await getFileResponse.json();

      // 删除文件
      const response = await fetch('https://api.github.com/repos/Doulor/Blog/contents/' + filePath, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + githubToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: '删除 ' + filePath + ' [通过内容管理器]',
          sha: fileData.sha
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || '删除失败');
      }

      showMessage('删除成功！页面将刷新以显示最新内容。');
      // 刷新页面以显示最新内容
      window.location.reload();
    } catch (error) {
      console.error('删除失败:', error);
      showMessage('删除失败: ' + error.message, 'error');
    }
  }

  // 搜索功能
  document.getElementById('search-input').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    // 获取当前活动的内容区域
    const activeSection = document.querySelector('.content-section:not(.hidden)');
    if (!activeSection) return;
    
    // 搜索当前活动区域内内容
    activeSection.querySelectorAll('article').forEach(card => {
      const title = card.querySelector('h3').textContent.toLowerCase();
      const description = card.querySelector('p');
      const descText = description ? description.textContent.toLowerCase() : '';
      const tags = Array.from(card.querySelectorAll('.btn-regular')).map(el => el.textContent.toLowerCase()).join(' ');

      if (title.includes(searchTerm) || descText.includes(searchTerm) || tags.includes(searchTerm)) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  });

  // 初始化页面
  document.addEventListener('DOMContentLoaded', function() {
    updateAuthStatus();

  });

  }

  // 触发初始化（首次加载 + Swup 无刷切换）
  function triggerContentManagerInit(attempt = 0) {
    const rootEl = document.getElementById('content-manager-root');
    if (!rootEl && attempt < 5) {
      return setTimeout(() => triggerContentManagerInit(attempt + 1), 50);
    }
    setTimeout(setupContentManager, 0);
  }

  document.addEventListener('DOMContentLoaded', () => triggerContentManagerInit());
  window.addEventListener('mizuki:page:loaded', () => triggerContentManagerInit());
  if (document.readyState !== 'loading') {
    triggerContentManagerInit();
  }
</script>

<style>
  .content-section.hidden {
    display: none;
  }
  
  .tab-btn.active {
    color: var(--primary);
    border-color: var(--primary);
  }
</style>