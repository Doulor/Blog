<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证完成 - Firef 博客内容管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <div class="mx-auto h-16 w-16 rounded-full bg-indigo-100 flex items-center justify-center">
                    <i class="fas fa-sync-alt text-indigo-600 text-2xl animate-spin"></i>
                </div>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    正在处理认证...
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600" id="statusMessage">
                    请稍候，正在安全地完成认证过程
                </p>
            </div>

            <div class="mt-8 bg-white py-8 px-4 shadow rounded-lg sm:px-10">
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                    <p class="text-gray-600">正在验证您的 GitHub 账户...</p>
                    
                    <div class="mt-6 bg-blue-50 border-l-4 border-blue-400 p-4 text-left">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    这个过程可能需要几秒钟，请不要关闭此页面
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 解析URL参数中的令牌信息
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 存储认证令牌
        function storeAuthData(tokenData) {
            // 清除之前的认证数据
            localStorage.removeItem('decap-cms-user');
            localStorage.removeItem('netlify-cms-user');
            
            // 存储新的认证数据，支持多种格式兼容
            const authInfo = {
                backend_token: tokenData.token || tokenData.access_token,
                access_token: tokenData.token || tokenData.access_token,
                token: tokenData.token || tokenData.access_token,
                api_token: tokenData.token || tokenData.access_token,
                login: tokenData.login || 'unknown',
                avatar_url: tokenData.avatar_url || '',
                expires_at: tokenData.expires_at || null,
                timestamp: new Date().toISOString()
            };
            
            // 存储到多个位置以确保兼容性
            localStorage.setItem('decap-cms-user', JSON.stringify(authInfo));
            localStorage.setItem('netlify-cms-user', JSON.stringify(authInfo)); 
            localStorage.setItem('github-auth-token', JSON.stringify(authInfo));
            
            console.log('认证数据已存储:', authInfo);
        }

        // 验证令牌有效性
        async function validateToken(token) {
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${token}` // GitHub OAuth 通常使用 Bearer 格式
                    },
                    method: 'GET'
                });
                
                if (!response.ok) {
                    throw new Error(`令牌验证失败: ${response.status}`);
                }
                
                const userData = await response.json();
                console.log('令牌验证成功，用户信息:', userData);
                return userData;
            } catch (error) {
                console.error('令牌验证错误:', error);
                throw error;
            }
        }

        // 完成认证过程
        async function completeAuthProcess() {
            try {
                // 尝试从URL参数获取令牌
                let token = getUrlParameter('token') || getUrlParameter('access_token');
                
                if (!token) {
                    // 尝试从URL哈希片段获取（某些OAuth流程使用hash fragment）
                    const hash = window.location.hash.substring(1);
                    const hashParams = new URLSearchParams(hash.replace(/&/g, '&'));
                    token = hashParams.get('token') || hashParams.get('access_token');
                }
                
                if (!token) {
                    throw new Error('未找到认证令牌，请重新进行认证');
                }

                // 验证令牌
                document.getElementById('statusMessage').textContent = '正在验证令牌...';
                const userData = await validateToken(token);
                
                // 存储认证数据
                document.getElementById('statusMessage').textContent = '正在保存认证信息...';
                storeAuthData({
                    token: token,
                    login: userData.login,
                    avatar_url: userData.avatar_url
                });
                
                // 更新UI并重定向
                document.getElementById('statusMessage').innerHTML = 
                    '<span class="text-green-600">认证成功！</span>';
                
                // 显示成功图标
                document.querySelector('.animate-spin').className = 'fas fa-check text-green-600 text-2xl';
                
                // 3秒后重定向到编辑器
                setTimeout(() => {
                    window.location.href = '/my-editor/';
                }, 3000);
                
            } catch (error) {
                console.error('认证过程错误:', error);
                document.getElementById('statusMessage').innerHTML = 
                    `<span class="text-red-600">认证失败: ${error.message}</span>`;
                
                // 显示错误图标
                document.querySelector('.animate-spin').className = 'fas fa-exclamation-triangle text-red-500 text-2xl';
                
                // 3秒后允许重试
                setTimeout(() => {
                    document.querySelector('.animate-spin').className = 'fas fa-redo text-yellow-500 text-2xl';
                    document.getElementById('statusMessage').innerHTML = 
                        '<a href="/auth.html" class="text-indigo-600 hover:text-indigo-800 underline">点击这里重试认证</a>';
                }, 3000);
            }
        }

        // 页面加载完成后执行认证流程
        document.addEventListener('DOMContentLoaded', function() {
            // 防止后退导致的缓存问题
            if (window.history.replaceState) {
                window.history.replaceState(null, null, window.location.pathname);
            }
            
            // 开始认证流程
            completeAuthProcess();
        });

        // 处理认证完成事件
        window.addEventListener('load', function() {
            // 发送消息到父窗口（如果在iframe中），以便其他地方可以监听
            if (window.opener) {
                window.opener.postMessage({ 
                    type: 'GITHUB_AUTH_COMPLETE',
                    success: true 
                }, '*');
                setTimeout(() => {
                    window.close(); // 关闭弹窗（如果是弹窗的话）
                }, 3000);
            }
        });
    </script>
</body>
</html>